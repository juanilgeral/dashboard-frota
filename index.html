<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Completo - Todas as Operações</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #283593;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #c62828;
            --info: #0277bd;
            --light: #f5f5f5;
            --dark: #212121;
            
            /* Cores das operações */
            --ls-color: #c62828; /* Vermelho */
            --ht-color: #2e7d32; /* Verde */
            --tl-color: #4caf50; /* Verde claro */
            --cv-color: #ff9800; /* Amarelo */
            --nl-color: #e57373; /* Vermelho claro */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
        }

        /* HEADER */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 30px;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2.8rem;
            color: #1a237e;
        }

        .logo h1 {
            color: #1a237e;
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .logo-subtitle {
            color: #666;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .date-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .date-btn {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            color: #424242;
        }

        .date-btn:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .date-btn.active {
            background: #1a237e;
            color: white;
            border-color: #1a237e;
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
        }

        #currentDateDisplay {
            font-weight: 700;
            color: #1a237e;
            font-size: 1.3rem;
            text-align: center;
            min-width: 280px;
        }

        .status-badge {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        /* LEGENDA DAS OPERAÇÕES */
        .operacoes-legend {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .legend-title {
            color: #1a237e;
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid;
            transition: all 0.3s;
        }

        .legend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .legend-badge {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 800;
            font-size: 1.1rem;
            color: white !important;
            flex-shrink: 0;
        }

        .legend-badge.LS { background: var(--ls-color); }
        .legend-badge.HT { background: var(--ht-color); }
        .legend-badge.TL { background: var(--tl-color); }
        .legend-badge.CV { background: var(--cv-color); }
        .legend-badge.NL { background: var(--nl-color); }

        .legend-info {
            flex: 1;
        }

        .legend-sigla {
            font-weight: 800;
            font-size: 1.1rem;
            margin-bottom: 2px;
        }

        .legend-sigla.LS { color: var(--ls-color); }
        .legend-sigla.HT { color: var(--ht-color); }
        .legend-sigla.TL { color: var(--tl-color); }
        .legend-sigla.CV { color: var(--cv-color); }
        .legend-sigla.NL { color: var(--nl-color); }

        .legend-nome {
            font-size: 0.9rem;
            color: #666;
            font-weight: 600;
        }

        /* OPERAÇÕES SUMMARY */
        .day-operations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .day-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .day-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .day-date {
            font-weight: 700;
            color: #1a237e;
            font-size: 1.2rem;
        }

        .day-count {
            background: #1a237e;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .operations-list {
            display: grid;
            gap: 12px;
        }

        .op-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            transition: all 0.2s;
            border-left: 4px solid;
        }

        .op-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }

        .op-badge {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 800;
            font-size: 1.1rem;
            margin-right: 15px;
            flex-shrink: 0;
            color: white !important;
        }

        .op-badge.LS { 
            background: var(--ls-color); 
            border: 2px solid #b71c1c;
        }
        .op-badge.HT { 
            background: var(--ht-color);
            border: 2px solid #1b5e20;
        }
        .op-badge.TL { 
            background: var(--tl-color);
            border: 2px solid #388e3c;
        }
        .op-badge.CV { 
            background: var(--cv-color);
            border: 2px solid #f57c00;
        }
        .op-badge.NL { 
            background: var(--nl-color);
            border: 2px solid #d32f2f;
        }

        .op-info {
            flex: 1;
        }

        .op-main {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .op-vehicles {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .op-item.LS { border-left-color: var(--ls-color); }
        .op-item.HT { border-left-color: var(--ht-color); }
        .op-item.TL { border-left-color: var(--tl-color); }
        .op-item.CV { border-left-color: var(--cv-color); }
        .op-item.NL { border-left-color: var(--nl-color); }

        /* LAYOUT DE DUAS COLUNAS */
        .two-columns-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        /* CONTROLE DIÁRIO DA FROTA */
        .controle-diario-card {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            color: white;
            position: relative;
            overflow: hidden;
            height: 100%;
        }

        .controle-diario-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #4caf50, #ff9800, #c62828);
            border-radius: 12px 12px 0 0;
        }

        .controle-diario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .controle-diario-titulo {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .controle-diario-titulo span {
            font-size: 2rem;
        }

        .controle-diario-data {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .controle-diario-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .controle-stat-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s;
        }

        .controle-stat-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .controle-stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controle-stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .controle-stat-sub {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* ESTILOS ESPECÍFICOS DO CONTROLE DIÁRIO */
        .controle-operations-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controle-operations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .controle-op-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controle-op-badge {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 800;
            font-size: 1rem;
            color: white;
            flex-shrink: 0;
        }

        .controle-op-info {
            flex: 1;
        }

        .controle-op-sigla {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .controle-op-count {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* NECESSIDADE DE CONTRATAÇÃO */
        .contratacao-status {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            position: relative;
            z-index: 2;
        }

        .contratacao-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .contratacao-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contratacao-icon {
            font-size: 1.5rem;
        }

        .contratacao-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .contratacao-item {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
        }

        .contratacao-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .contratacao-value {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .contratacao-difference {
            font-size: 0.9rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 700;
            display: inline-block;
        }

        .contratacao-difference.positive {
            background: rgba(46, 125, 50, 0.3);
            color: #a5d6a7;
        }

        .contratacao-difference.negative {
            background: rgba(198, 40, 40, 0.3);
            color: #ffabab;
        }

        .contratacao-difference.neutral {
            background: rgba(255, 152, 0, 0.3);
            color: #ffcc80;
        }

        .contratacao-status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
        }

        .contratacao-status-badge.sufficient {
            background: rgba(46, 125, 50, 0.3);
            color: #a5d6a7;
            border: 2px solid rgba(76, 175, 80, 0.3);
        }

        .contratacao-status-badge.insufficient {
            background: rgba(198, 40, 40, 0.3);
            color: #ffabab;
            border: 2px solid rgba(244, 67, 54, 0.3);
        }

        .contratacao-status-badge.marginal {
            background: rgba(255, 152, 0, 0.3);
            color: #ffcc80;
            border: 2px solid rgba(255, 193, 7, 0.3);
        }

        /* RELAÇÃO VEÍCULOS/MOTORISTAS */
        .relacao-veiculos-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: relative;
            height: 100%;
        }

        .relacao-veiculos-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #1a237e, #283593, #3949ab);
            border-radius: 12px 12px 0 0;
        }

        .relacao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .relacao-titulo {
            color: #1a237e;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .relacao-titulo span {
            font-size: 2rem;
        }

        .relacao-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .relacao-btn {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .relacao-btn:hover {
            background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
        }

        .relacao-btn.warning {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        }

        .relacao-btn.warning:hover {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .relacao-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .relacao-section {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        .relacao-section-title {
            color: #1a237e;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0f0;
        }

        .relacao-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .relacao-list::-webkit-scrollbar {
            width: 6px;
        }

        .relacao-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .relacao-list::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .relacao-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #1a237e;
            transition: all 0.2s;
        }

        .relacao-item:hover {
            background: #f0f0f0;
            transform: translateX(3px);
        }

        .relacao-nome {
            font-weight: 600;
            color: #424242;
            flex: 1;
        }

        .relacao-count {
            background: #1a237e;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.9rem;
            min-width: 50px;
            text-align: center;
        }

        .relacao-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .relacao-summary-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            border-radius: 8px;
            color: white;
        }

        .relacao-summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .relacao-summary-value {
            font-size: 2rem;
            font-weight: 800;
        }

        /* NOVA SEÇÃO: MOTORISTAS NÃO ESCALADOS */
        .nao-escalados-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            position: relative;
        }

        .nao-escalados-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff9800, #ffb74d, #ffcc80);
            border-radius: 12px 12px 0 0;
        }

        .nao-escalados-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .nao-escalados-titulo {
            color: #1a237e;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nao-escalados-titulo span {
            font-size: 2rem;
        }

        .nao-escalados-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nao-escalados-select {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-weight: 600;
            color: #424242;
            cursor: pointer;
            min-width: 200px;
            font-size: 0.95rem;
        }

        .nao-escalados-select:focus {
            outline: none;
            border-color: #ff9800;
        }

        .nao-escalados-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .nao-escalados-grid {
                grid-template-columns: 1fr;
            }
        }

        .nao-escalados-section {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        .nao-escalados-section-title {
            color: #ff9800;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffe0b2;
        }

        .nao-escalados-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .nao-escalados-list::-webkit-scrollbar {
            width: 6px;
        }

        .nao-escalados-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .nao-escalados-list::-webkit-scrollbar-thumb {
            background: #ffcc80;
            border-radius: 10px;
        }

        .nao-escalados-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #ff9800;
            transition: all 0.2s;
        }

        .nao-escalados-item:hover {
            background: #fff3e0;
            transform: translateX(3px);
        }

        .nao-escalados-nome {
            font-weight: 600;
            color: #424242;
            flex: 1;
        }

        .nao-escalados-info {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nao-escalados-dias {
            background: #ff9800;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.9rem;
            min-width: 60px;
            text-align: center;
        }

        .nao-escalados-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .nao-escalados-status.folga {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .nao-escalados-status.ferias {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .nao-escalados-status.inativo {
            background: #f5f5f5;
            color: #757575;
            border: 1px solid #e0e0e0;
        }

        .nao-escalados-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #f0f0f0;
        }

        .nao-escalados-summary-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            border-radius: 8px;
            color: white;
        }

        .nao-escalados-summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .nao-escalados-summary-value {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .nao-escalados-alerta {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
            font-size: 0.95rem;
            color: #5d4037;
        }

        .nao-escalados-alerta strong {
            color: #ff9800;
        }

        /* MODAL DE ATUALIZAÇÃO */
        .update-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .update-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .update-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .update-modal-title {
            color: #1a237e;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #f5f5f5;
            color: #c62828;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #424242;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #1a237e;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .form-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            margin-bottom: 15px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #1b5e20 0%, #388e3c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        /* DASHBOARD LAYOUT */
        .dashboard-main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        /* TABELA PRINCIPAL */
        .table-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            min-height: 700px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            color: #1a237e;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title-icon {
            font-size: 1.8rem;
        }

        .filters-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-weight: 600;
            color: #424242;
            cursor: pointer;
            min-width: 180px;
            font-size: 0.95rem;
        }

        .filter-select:focus {
            outline: none;
            border-color: #1a237e;
        }

        .table-container {
            border-radius: 8px;
            border: 1px solid #f0f0f0;
            overflow-y: visible;
            overflow-x: auto;
            max-height: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        th {
            background: #f5f5f5;
            padding: 18px 20px;
            text-align: left;
            color: #424242;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 0.95rem;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f9f9f9;
        }

        tbody tr.finalizado {
            background: #f1f8e9;
        }

        tbody tr.em-rota {
            background: #e3f2fd;
        }

        tbody tr.pendente {
            background: #fffde7;
        }

        tbody tr.sem-destino {
            background: #f5f5f5;
            opacity: 0.7;
        }

        tbody tr.sem-destino:hover {
            background: #eeeeee;
        }

        tbody tr.veiculo-finalizado {
            background: #fff8e1 !important;
        }

        tbody tr.veiculo-finalizado:hover {
            background: #ffecb3 !important;
        }

        td .op-cell {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 1rem;
            display: inline-block;
            text-align: center;
            min-width: 50px;
            color: white !important;
        }

        .op-cell.LS { background: var(--ls-color); }
        .op-cell.HT { background: var(--ht-color); }
        .op-cell.TL { background: var(--tl-color); }
        .op-cell.CV { background: var(--cv-color); }
        .op-cell.NL { background: var(--nl-color); }

        .status-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-finalizado {
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #c8e6c9;
        }

        .status-em-rota {
            background: #e3f2fd;
            color: #1565c0;
            border: 2px solid #bbdefb;
        }

        .status-pendente {
            background: #fff8e1;
            color: #ff8f00;
            border: 2px solid #ffecb3;
        }

        .status-sem-destino {
            background: #f5f5f5;
            color: #757575;
            border: 2px solid #e0e0e0;
        }

        /* NOVOS ESTILOS PARA O BOTÃO DE CONTROLE REDONDO */
        .controle-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .controle-btn.inicial {
            background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
            color: white;
        }

        .controle-btn.inicial:hover {
            background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(198, 40, 40, 0.4);
        }

        .controle-btn.inicial:active {
            transform: scale(0.95);
        }

        .controle-btn.fim-viagem {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: white;
            border-radius: 20px;
            width: auto;
            min-width: 120px;
            height: 40px;
            padding: 0 20px;
            font-size: 0.9rem;
            font-weight: 700;
            animation: pulse-yellow 1.5s infinite;
        }

        .controle-btn.fim-viagem:hover {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        .controle-btn.fim-viagem:active {
            transform: translateY(0);
        }

        @keyframes pulse-yellow {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 152, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
            }
        }

        .controle-btn.sem-destino {
            background: #e0e0e0;
            color: #757575;
            cursor: not-allowed;
            opacity: 0.7;
            width: auto;
            min-width: 120px;
            height: 40px;
            padding: 0 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .controle-btn.sem-destino:hover {
            transform: none;
            box-shadow: none;
        }

        .trip-badge {
            background: #ff9800;
            color: white;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 700;
            margin-left: 6px;
        }

        /* ESTATÍSTICAS DE ROTA */
        .rota-stats {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 25px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .stats-title {
            color: #1a237e;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .export-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #1b5e20 0%, #388e3c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .copy-btn {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
        }

        .rota-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #1a237e;
        }

        .rota-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .rota-titulo {
            font-weight: 700;
            color: #1a237e;
            font-size: 1.1rem;
        }

        .rota-metricas {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .rota-veiculos {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e0e0e0;
        }

        /* MODAL DE EXPORTAÇÃO */
        .export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .export-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .export-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .export-modal-title {
            color: #1a237e;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #f5f5f5;
            color: #c62828;
        }

        .export-options {
            margin-bottom: 25px;
        }

        .export-option {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #1a237e;
        }

        .export-option h3 {
            color: #1a237e;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .export-option p {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .export-textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            resize: vertical;
            margin-bottom: 15px;
        }

        .export-textarea:focus {
            outline: none;
            border-color: #1a237e;
        }

        .export-instructions {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #666;
        }

        .export-instructions h4 {
            color: #1a237e;
            margin-bottom: 10px;
        }

        .export-instructions ul {
            list-style: none;
            padding-left: 0;
        }

        .export-instructions li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .export-instructions li::before {
            content: "•";
            color: #1a237e;
            position: absolute;
            left: 0;
        }

        /* UPLOAD SECTION */
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-top: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .upload-title {
            color: #1a237e;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .upload-box {
            border: 3px dashed #e0e0e0;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 25px;
        }

        .upload-box:hover {
            border-color: #1a237e;
            background: #f5f5f5;
        }

        .upload-icon {
            font-size: 4rem;
            color: #1a237e;
            margin-bottom: 20px;
        }

        .upload-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .upload-btn {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
            min-width: 200px;
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
        }

        .upload-btn.danger {
            background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
        }

        .upload-btn.danger:hover {
            background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%);
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
        }

        .upload-btn.warning {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        }

        .upload-btn.warning:hover {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .upload-btn.success {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
        }

        .upload-btn.success:hover {
            background: linear-gradient(135deg, #1b5e20 0%, #388e3c 100%);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .upload-instructions {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .instructions-title {
            color: #1a237e;
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .instructions-list {
            list-style: none;
            padding-left: 0;
        }

        .instructions-list li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
            color: #666;
        }

        .instructions-list li::before {
            content: "•";
            color: #1a237e;
            font-size: 1.5rem;
            position: absolute;
            left: 0;
            top: -5px;
        }

        /* PASSWORD MODAL */
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .password-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .password-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .password-modal-title {
            color: #1a237e;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .password-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            font-family: monospace;
        }

        .password-input:focus {
            outline: none;
            border-color: #1a237e;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .password-error {
            color: #c62828;
            font-size: 0.9rem;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }

        .password-btn {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .password-btn:hover {
            background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
        }

        /* LOADING */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1a237e;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* FOOTER */
        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .header {
                grid-template-columns: 1fr;
                gap: 20px;
                text-align: center;
            }
            
            .date-controls {
                justify-content: center;
            }
            
            #currentDateDisplay {
                min-width: auto;
            }
            
            .legend-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
            
            .stats-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .export-controls {
                width: 100%;
                justify-content: flex-start;
            }
            
            .relacao-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .two-columns-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .day-operations {
                grid-template-columns: 1fr;
            }
            
            .filters-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-select {
                width: 100%;
            }
            
            .upload-box {
                padding: 30px 20px;
            }
            
            .legend-grid {
                grid-template-columns: 1fr;
            }
            
            .controle-diario-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controle-operations-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controle-diario-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .export-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .export-btn, .copy-btn {
                width: 100%;
                justify-content: center;
            }
            
            .upload-controls {
                flex-direction: column;
            }
            
            .upload-btn {
                width: 100%;
            }
            
            .relacao-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .relacao-btn {
                width: 100%;
                justify-content: center;
            }
            
            .relacao-summary {
                grid-template-columns: 1fr;
            }
            
            .two-columns-layout {
                grid-template-columns: 1fr;
            }
            
            .contratacao-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .controle-diario-stats {
                grid-template-columns: 1fr;
            }
            
            .controle-operations-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">🚛</div>
                <div>
                    <h1>Sistema de Controle de Frota</h1>
                    <div class="logo-subtitle">Todas as operações • Controle manual • Dados completos</div>
                </div>
            </div>
            
            <div class="date-controls">
                <button class="date-btn active" onclick="loadDate('today')">HOJE</button>
                <button class="date-btn" onclick="loadDate('yesterday')">ONTEM</button>
                <button class="date-btn" onclick="loadDate('all')">TODOS</button>
                <div id="currentDateDisplay">Carregando data...</div>
            </div>
            
            <div class="status-badge">
                <span>📊</span> TODAS OPERAÇÕES
            </div>
        </div>

        <!-- LEGENDA DAS OPERAÇÕES -->
        <div class="operacoes-legend">
            <div class="legend-title">
                <span>🎯</span>
                Legenda das Operações
            </div>
            <div class="legend-grid">
                <div class="legend-item LS">
                    <div class="legend-badge LS">LS</div>
                    <div class="legend-info">
                        <div class="legend-sigla LS">LS</div>
                        <div class="legend-nome">Lasa</div>
                    </div>
                </div>
                <div class="legend-item HT">
                    <div class="legend-badge HT">HT</div>
                    <div class="legend-info">
                        <div class="legend-sigla HT">HT</div>
                        <div class="legend-nome">Hortifruti</div>
                    </div>
                </div>
                <div class="legend-item TL">
                    <div class="legend-badge TL">TL</div>
                    <div class="legend-info">
                        <div class="legend-sigla TL">TL</div>
                        <div class="legend-nome">Tele Rio</div>
                    </div>
                </div>
                <div class="legend-item CV">
                    <div class="legend-badge CV">CV</div>
                    <div class="legend-info">
                        <div class="legend-sigla CV">CV</div>
                        <div class="legend-nome">Casa & Vídeo</div>
                    </div>
                </div>
                <div class="legend-item NL">
                    <div class="legend-badge NL">NL</div>
                    <div class="legend-info">
                        <div class="legend-sigla NL">NL</div>
                        <div class="legend-nome">Nalin</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESUMO DOS ÚLTIMOS 3 DIAS (COMEÇANDO DO DIA ATUAL) -->
        <div class="day-operations" id="last3DaysSummary">
            <!-- Carregado dinamicamente -->
        </div>

        <!-- LAYOUT DE DUAS COLUNAS -->
        <div class="two-columns-layout">
            <!-- CONTROLE DIÁRIO DA FROTA -->
            <div class="controle-diario-card" id="controleDiario">
                <!-- Carregado dinamicamente -->
            </div>

            <!-- RELAÇÃO VEÍCULOS/MOTORISTAS -->
            <div class="relacao-veiculos-card" id="relacaoVeiculosCard">
                <div class="relacao-header">
                    <div class="relacao-titulo">
                        <span>🚚</span>
                        Relação Veículos/Motoristas
                    </div>
                    <div class="relacao-controls">
                        <button class="relacao-btn" onclick="openUpdateVeiculosModal()">
                            <span>📝</span>
                            Atualizar Veículos
                        </button>
                        <button class="relacao-btn warning" onclick="openUpdateMotoristasModal()">
                            <span>👷</span>
                            Atualizar Motoristas
                        </button>
                    </div>
                </div>
                
                <div class="relacao-grid">
                    <div class="relacao-section">
                        <div class="relacao-section-title">
                            <span>🚛</span>
                            Veículos em Operação
                            <span style="margin-left: auto; font-size: 0.9rem; color: #666;" id="totalVeiculosInfo">Total: 0</span>
                        </div>
                        <div class="relacao-list" id="veiculosList">
                            <!-- Carregado dinamicamente -->
                        </div>
                    </div>
                    
                    <div class="relacao-section">
                        <div class="relacao-section-title">
                            <span>👷</span>
                            Motoristas Ativos
                            <span style="margin-left: auto; font-size: 0.9rem; color: #666;" id="totalMotoristasInfo">Total: 0</span>
                        </div>
                        <div class="relacao-list" id="motoristasList">
                            <!-- Carregado dinamicamente -->
                        </div>
                    </div>
                </div>
                
                <div class="relacao-summary">
                    <div class="relacao-summary-item">
                        <div class="relacao-summary-label">Total de Veículos</div>
                        <div class="relacao-summary-value" id="totalVeiculos">0</div>
                    </div>
                    <div class="relacao-summary-item">
                        <div class="relacao-summary-label">Total de Motoristas</div>
                        <div class="relacao-summary-value" id="totalMotoristas">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DASHBOARD PRINCIPAL -->
        <div class="dashboard-main">
            <div class="table-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-title-icon">📋</span>
                        Todas as Viagens
                        <span id="tripCount" style="font-size: 0.95rem; color: #666; font-weight: normal;">(0 viagens com destino válido)</span>
                    </div>
                    <div class="filters-row">
                        <select class="filter-select" id="dateFilter" onchange="filterTable()">
                            <option value="all">Todas as Datas</option>
                            <!-- Datas carregadas dinamicamente -->
                        </select>
                        <select class="filter-select" id="opFilter" onchange="filterTable()">
                            <option value="all">Todas Operações</option>
                            <option value="LS">LS</option>
                            <option value="HT">HT</option>
                            <option value="TL">TL</option>
                            <option value="CV">CV</option>
                            <option value="NL">NL</option>
                        </select>
                        <select class="filter-select" id="statusFilter" onchange="filterTable()">
                            <option value="all">Todos Status</option>
                            <option value="com-destino">Com Destino Válido</option>
                            <option value="sem-destino">Sem Destino Válido</option>
                            <option value="pendente">Pendentes</option>
                            <option value="em-rota">Em Rota</option>
                            <option value="finalizado">Finalizados</option>
                        </select>
                        <select class="filter-select" id="destinoFilter" onchange="filterTable()">
                            <option value="all">Todos (com/sem destino)</option>
                            <option value="com-destino" selected>Apenas com Destino Válido</option>
                            <option value="sem-destino">Apenas sem Destino Válido</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="mainTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>DATA</th>
                                <th>OP</th>
                                <th>Veículo</th>
                                <th>Motorista</th>
                                <th>Ponto ON</th>
                                <th>Saída CD</th>
                                <th>Destino</th>
                                <th>Ponto OFF</th>
                                <th>Status</th>
                                <th>Controle</th>
                                <th>Viagem</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Dados carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NOVA SEÇÃO: MOTORISTAS NÃO ESCALADOS -->
        <div class="nao-escalados-card" id="naoEscaladosCard">
            <div class="nao-escalados-header">
                <div class="nao-escalados-titulo">
                    <span>👥</span>
                    Análise de Motoristas Não Escalados
                </div>
                <div class="nao-escalados-controls">
                    <select class="nao-escalados-select" id="naoEscaladosDateFilter" onchange="updateNaoEscalados()">
                        <option value="hoje">Dia Selecionado</option>
                        <option value="7dias">Últimos 7 Dias</option>
                        <option value="15dias">Últimos 15 Dias</option>
                        <option value="30dias">Últimos 30 Dias</option>
                    </select>
                </div>
            </div>
            
            <div class="nao-escalados-grid">
                <div class="nao-escalados-section">
                    <div class="nao-escalados-section-title">
                        <span>⏸️</span>
                        Motoristas em Folga (Hoje)
                    </div>
                    <div class="nao-escalados-list" id="folgaList">
                        <!-- Carregado dinamicamente -->
                    </div>
                </div>
                
                <div class="nao-escalados-section">
                    <div class="nao-escalados-section-title">
                        <span>🏖️</span>
                        Possíveis Férias/Afastamentos
                    </div>
                    <div class="nao-escalados-list" id="feriasList">
                        <!-- Carregado dinamicamente -->
                    </div>
                </div>
            </div>
            
            <div class="nao-escalados-summary">
                <div class="nao-escalados-summary-item">
                    <div class="nao-escalados-summary-label">Total de Motoristas</div>
                    <div class="nao-escalados-summary-value" id="totalMotoristasTodos">0</div>
                </div>
                <div class="nao-escalados-summary-item">
                    <div class="nao-escalados-summary-label">Em Operação Hoje</div>
                    <div class="nao-escalados-summary-value" id="motoristasHoje">0</div>
                </div>
                <div class="nao-escalados-summary-item">
                    <div class="nao-escalados-summary-label">Não Escalados Hoje</div>
                    <div class="nao-escalados-summary-value" id="naoEscaladosHoje">0</div>
                </div>
                <div class="nao-escalados-summary-item">
                    <div class="nao-escalados-summary-label">Média de Dias Sem Trabalhar</div>
                    <div class="nao-escalados-summary-value" id="mediaDiasFolga">0</div>
                </div>
            </div>
            
            <div class="nao-escalados-alerta">
                <strong>📋 Análise de Padrão:</strong> Esta seção identifica motoristas que não foram escalados recentemente, 
                permitindo identificar padrões de folgas, possíveis férias ou afastamentos. 
                Motoristas com mais de 7 dias sem trabalhar são destacados para análise.
            </div>
        </div>

        <!-- ESTATÍSTICAS DE ROTAS FREQUENTES -->
        <div class="rota-stats">
            <div class="stats-header">
                <div class="stats-title">
                    <span>📈</span>
                    Estatísticas de Rotas Frequentes (Apenas viagens com destino válido)
                </div>
                <div class="export-controls">
                    <button class="export-btn" onclick="openExportModal()">
                        📊 Exportar Dados
                    </button>
                    <button class="copy-btn" onclick="copyRoutesToClipboard()">
                        📋 Copiar para Planilha
                    </button>
                </div>
            </div>
            <div id="rotaFrequenteContent">
                <!-- Rotas frequentes carregadas aqui -->
            </div>
        </div>

        <!-- UPLOAD E CONTROLE -->
        <div class="upload-section">
            <div class="upload-title">
                <span>📤</span>
                Atualização de Dados Completa
            </div>
            
            <div class="upload-box" onclick="requestPassword()">
                <div class="upload-icon">📁</div>
                <p style="font-size: 1.2rem; margin-bottom: 10px; color: #1a237e; font-weight: 700;">
                    Importar Planilha Completa
                </p>
                <p style="color: #666;">
                    Clique para importar todos os dados da sua planilha (Somente Supervisão)
                </p>
            </div>
            
            <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileUpload(event)">
            
            <!-- BOTÕES DE CONTROLE ADICIONAIS -->
            <div class="upload-controls">
                <button class="upload-btn danger" onclick="confirmClearData()">
                    🗑️ Limpar Todos os Dados
                </button>
            </div>
            
            <div class="upload-instructions">
                <div class="instructions-title">📋 Como funciona:</div>
                <ul class="instructions-list">
                    <li><strong>Todos os dados</strong> da planilha são processados e atualizados</li>
                    <li><strong>Viagens consideradas:</strong> Apenas registros com campo Destino válido</li>
                    <li><strong>Destinos inválidos:</strong> COBRANÇA 50%, Garagem X..., ... X Garagem, campos vazios</li>
                    <li><strong>Controle manual</strong> de finalização preservado</li>
                    <li><strong>Últimos 3 dias</strong> mostrados no resumo acima</li>
                    <li><strong>Senha de supervisão:</strong> @admin0768# (necessária para importar dados)</li>
                    <li><strong>Relação Veículos/Motoristas:</strong> Atualize manualmente os totais</li>
                    <li><strong>Análise de Não Escalados:</strong> Identifica motoristas em folga ou possíveis férias</li>
                </ul>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <p>Sistema Completo de Controle de Frota • Todas as operações • Apenas viagens com destino válido</p>
            <p>Total de registros: <span id="totalRecords">0</span> • Viagens com destino válido: <span id="totalViagensComDestino">0</span> • Última atualização: <span id="lastUpdate">Carregando...</span></p>
        </div>
    </div>

    <!-- MODAL DE ATUALIZAÇÃO DE VEÍCULOS -->
    <div class="update-modal" id="updateVeiculosModal">
        <div class="update-modal-content">
            <div class="update-modal-header">
                <div class="update-modal-title">
                    <span>🚛</span>
                    Atualizar Total de Veículos
                </div>
                <button class="close-btn" onclick="closeUpdateVeiculosModal()">×</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Total de Veículos em Operação:</label>
                <input type="number" id="veiculosInput" class="form-input" min="0" max="100" placeholder="Ex: 25" value="0">
                <div class="form-text">Informe o número total de veículos disponíveis para operação.</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Distribuição por Operação (opcional):</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="font-size: 0.9rem; color: #666;">LS:</label>
                        <input type="number" id="veiculosLS" class="form-input" min="0" placeholder="0" style="font-size: 0.9rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666;">HT:</label>
                        <input type="number" id="veiculosHT" class="form-input" min="0" placeholder="0" style="font-size: 0.9rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666;">TL:</label>
                        <input type="number" id="veiculosTL" class="form-input" min="0" placeholder="0" style="font-size: 0.9rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666;">CV:</label>
                        <input type="number" id="veiculosCV" class="form-input" min="0" placeholder="0" style="font-size: 0.9rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #666;">NL:</label>
                        <input type="number" id="veiculosNL" class="form-input" min="0" placeholder="0" style="font-size: 0.9rem;">
                    </div>
                </div>
                <div class="form-text">Preencha a distribuição por operação para um controle mais detalhado.</div>
            </div>
            
            <button class="submit-btn" onclick="updateVeiculos()">
                <span>💾</span>
                Salvar Alterações
            </button>
        </div>
    </div>

    <!-- MODAL DE ATUALIZAÇÃO DE MOTORISTAS -->
    <div class="update-modal" id="updateMotoristasModal">
        <div class="update-modal-content">
            <div class="update-modal-header">
                <div class="update-modal-title">
                    <span>👷</span>
                    Atualizar Total de Motoristas
                </div>
                <button class="close-btn" onclick="closeUpdateMotoristasModal()">×</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Total de Motoristas Ativos:</label>
                <input type="number" id="motoristasInput" class="form-input" min="0" max="50" placeholder="Ex: 18" value="0">
                <div class="form-text">Informe o número total de motoristas disponíveis para operação.</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Adicionar Motoristas (opcional):</label>
                <textarea id="motoristasListInput" class="form-input" rows="4" placeholder="Digite os nomes dos motoristas, um por linha
Ex:
João Silva
Maria Santos
Carlos Oliveira"></textarea>
                <div class="form-text">Adicione os nomes dos motoristas, um por linha. Os nomes serão combinados com os já existentes.</div>
            </div>
            
            <button class="submit-btn" onclick="updateMotoristas()">
                <span>💾</span>
                Salvar Alterações
            </button>
        </div>
    </div>

    <!-- MODAL DE SENHA -->
    <div class="password-modal" id="passwordModal">
        <div class="password-modal-content">
            <div class="password-modal-header">
                <div class="password-modal-title">
                    <span>🔒</span>
                    Autenticação de Supervisão
                </div>
                <button class="close-btn" onclick="closePasswordModal()">×</button>
            </div>
            
            <p style="color: #666; margin-bottom: 20px; text-align: center;">
                Esta ação requer autorização de supervisão.<br>
                Digite a senha para continuar.
            </p>
            
            <input type="password" id="passwordInput" class="password-input" placeholder="Digite a senha de supervisão">
            
            <div class="password-error" id="passwordError">
                Senha incorreta. Tente novamente.
            </div>
            
            <button class="password-btn" onclick="verifyPassword()">
                <span>🔑</span>
                Verificar Senha
            </button>
        </div>
    </div>

    <!-- MODAL DE EXPORTAÇÃO -->
    <div class="export-modal" id="exportModal">
        <div class="export-modal-content">
            <div class="export-modal-header">
                <div class="export-modal-title">
                    <span>📊</span>
                    Exportar Dados das Rotas Frequentes
                </div>
                <button class="close-btn" onclick="closeExportModal()">×</button>
            </div>
            
            <div class="export-options">
                <div class="export-option">
                    <h3>📋 Formato Excel/Planilha Google</h3>
                    <p>Cole os dados abaixo diretamente na primeira célula (A1) de uma planilha Excel ou Google Sheets:</p>
                    <textarea class="export-textarea" id="exportExcelData" readonly></textarea>
                    <button class="copy-btn" onclick="copyExcelData()">
                        📋 Copiar Dados para Excel
                    </button>
                </div>
                
                <div class="export-option">
                    <h3>📊 Dados Detalhados (JSON)</h3>
                    <p>Dados completos em formato JSON para análise avançada:</p>
                    <textarea class="export-textarea" id="exportJsonData" readonly></textarea>
                    <button class="copy-btn" onclick="copyJsonData()">
                        📋 Copiar Dados JSON
                    </button>
                </div>
                
                <div class="export-instructions">
                    <h4>📝 Como usar os dados exportados:</h4>
                    <ul>
                        <li><strong>Excel:</strong> Cole na célula A1, selecione "Dados" → "Texto para Colunas" → Delimitado → Vírgula</li>
                        <li><strong>Google Sheets:</strong> Cole na célula A1, selecione "Dados" → "Dividir texto em colunas" → Vírgula</li>
                        <li><strong>Data de exportação:</strong> Os dados incluem a data atual para referência</li>
                        <li><strong>Filtros aplicados:</strong> Apenas viagens com destino válido são incluídas</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="font-size: 1.2rem; color: #1a237e; font-weight: 700;">Carregando todas as operações...</div>
    </div>

    <script>
        // ============================================
        // DADOS INICIAIS DA PLANILHA (VÁZIO - COMEÇA COM DATA VIGENTE)
        // ============================================
        function getTodayDateString() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = String(today.getFullYear()).slice(2);
            return `${day}/${month}/${year}`;
        }

        function getYesterdayDateString() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const day = String(yesterday.getDate()).padStart(2, '0');
            const month = String(yesterday.getMonth() + 1).padStart(2, '0');
            const year = String(yesterday.getFullYear()).slice(2);
            return `${day}/${month}/${year}`;
        }

        function getDayBeforeYesterdayDateString() {
            const dayBefore = new Date();
            dayBefore.setDate(dayBefore.getDate() - 2);
            const day = String(dayBefore.getDate()).padStart(2, '0');
            const month = String(dayBefore.getMonth() + 1).padStart(2, '0');
            const year = String(dayBefore.getFullYear()).slice(2);
            return `${day}/${month}/${year}`;
        }

        const initialFrotaData = `DATA,DIA,OP,VEICULO,MOTORISTA,PONTO_ON_MOT.,PREVISÃO_REFEIÇÃO,PONTO_OFF_MOTO.,PRÓX_HORA_DISP,DESTINO,SAÍDA_VEÍCULO_CD
${getDayBeforeYesterdayDateString()},qua.,LS,064 LUV 9296,MARTINS,05:13:00,10:13:00,14:09:00,01:09:00,069 - CAXIAS / 774 - SHOP. CAXIAS,06:10:00
${getDayBeforeYesterdayDateString()},qua.,LS,065 KZQ 9648,JOEL,09:48:00,14:48:00,,,GARAGEM X LASA,10:14:00
${getYesterdayDateString()},qui.,LS,066 LUB 1400,JOEL,09:48:00,14:48:00,16:18:00,03:18:00,GARAGEM X LASA,14:19:00
${getYesterdayDateString()},qui.,LS,067 LUX 9063,CÉLIO,05:00:00,10:00:00,16:25:00,03:25:00,164 - SHOP. CARIOCA / 258 - SHOP. MADUREIRA,06:20:00
${getTodayDateString()},sex.,LS,068 LUV 9297,ANTÔNIO,05:00:00,10:00:00,,,025 - TIJUCA / 648 - CENTRO,06:15:00`;

        // ============================================
        // VARIÁVEIS GLOBAIS
        // ============================================
        let frotaData = [];
        let manualFinalizations = {};
        let allDates = [];
        let driverStatistics = {};
        let routeStatistics = {};
        let vehicleStatistics = {};
        
        // Dados de veículos e motoristas
        let veiculosData = {
            total: 0,
            distribuicao: {
                LS: 0,
                HT: 0,
                TL: 0,
                CV: 0,
                NL: 0
            }
        };
        
        let motoristasData = {
            total: 0,
            lista: []
        };
        
        // Dados de análise de não escalados
        let naoEscaladosAnalysis = {
            motoristasHoje: new Set(),
            motoristasTodos: new Set(),
            diasSemTrabalhar: {},
            ultimoTrabalho: {},
            padroesFolga: {},
            motoristasEscaladosHoje: new Set(),
            motoristasComDestinoValidoHoje: new Set()
        };
        
        // Senha de supervisão
        const SUPERVISOR_PASSWORD = "@admin0768#";

        // Mapeamento das operações
        const operacoesMap = {
            'LS': { nome: 'Lasa', cor: '#c62828' },
            'HT': { nome: 'Hortifruti', cor: '#2e7d32' },
            'TL': { nome: 'Tele Rio', cor: '#4caf50' },
            'CV': { nome: 'Casa & Vídeo', cor: '#ff9800' },
            'NL': { nome: 'Nalin', cor: '#e57373' }
        };

        // ============================================
        // FUNÇÕES PRINCIPAIS
        // ============================================

        // INICIALIZAR SISTEMA
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard inicializando...');
            initializeSystem();
        });

        function initializeSystem() {
            showLoading();
            
            try {
                // Atualizar data de exibição
                updateCurrentDateDisplay();
                
                // Carregar dados do localStorage
                loadDataFromStorage();
                
                // Carregar dados de veículos e motoristas
                loadVeiculosMotoristasData();
                
                // Carregar finalizações manuais
                loadManualFinalizations();
                
                // Aplicar finalizações manuais aos dados
                applyManualFinalizations();
                
                // Identificar viagens múltiplas
                identifyMultipleTrips();
                
                // Extrair todas as datas únicas
                extractAllDates();
                
                // Calcular estatísticas avançadas
                calculateAdvancedStatistics();
                
                // Calcular análise de não escalados
                calculateNaoEscaladosAnalysis();
                
                // Carregar interface
                loadLast3DaysSummary();
                loadControleDiario();
                updateDateFilterOptions();
                loadTableData();
                updateNaoEscalados();
                updateRotaFrequente();
                updateRelacaoVeiculosMotoristas();
                updateTimestamp();
                
                // Atualizar contadores
                updateCounters();
                
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showNotification('Erro ao carregar dados: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ATUALIZAR DATA DE EXIBIÇÃO ATUAL
        function updateCurrentDateDisplay() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const dateString = now.toLocaleDateString('pt-BR', options);
            document.getElementById('currentDateDisplay').textContent = dateString;
        }

        // CARREGAR DADOS DO LOCALSTORAGE
        function loadDataFromStorage() {
            const savedData = localStorage.getItem('frotaCSVData');
            
            if (savedData) {
                processCSVData(savedData);
            } else {
                processCSVData(initialFrotaData);
            }
        }

        // CARREGAR DADOS DE VEÍCULOS E MOTORISTAS
        function loadVeiculosMotoristasData() {
            // Carregar veículos
            const savedVeiculos = localStorage.getItem('frotaVeiculosData');
            if (savedVeiculos) {
                try {
                    veiculosData = JSON.parse(savedVeiculos);
                    console.log('Veículos carregados:', veiculosData);
                } catch (e) {
                    console.error('Erro ao carregar veículos:', e);
                    veiculosData = {
                        total: 0,
                        distribuicao: {
                            LS: 0,
                            HT: 0,
                            TL: 0,
                            CV: 0,
                            NL: 0
                        }
                    };
                }
            } else {
                console.log('Nenhum dado de veículos encontrado no localStorage');
            }
            
            // Carregar motoristas
            const savedMotoristas = localStorage.getItem('frotaMotoristasData');
            if (savedMotoristas) {
                try {
                    motoristasData = JSON.parse(savedMotoristas);
                    console.log('Motoristas carregados:', motoristasData);
                    
                    // Verificar se o total está correto
                    if (motoristasData.total !== motoristasData.lista.length) {
                        console.warn(`Total de motoristas (${motoristasData.total}) não corresponde à lista (${motoristasData.lista.length}). Corrigindo...`);
                        motoristasData.total = motoristasData.lista.length;
                        saveVeiculosMotoristasData();
                    }
                } catch (e) {
                    console.error('Erro ao carregar motoristas:', e);
                    motoristasData = {
                        total: 0,
                        lista: []
                    };
                }
            } else {
                console.log('Nenhum dado de motoristas encontrado no localStorage');
            }
        }

        // SALVAR DADOS DE VEÍCULOS E MOTORISTAS
        function saveVeiculosMotoristasData() {
            try {
                localStorage.setItem('frotaVeiculosData', JSON.stringify(veiculosData));
                localStorage.setItem('frotaMotoristasData', JSON.stringify(motoristasData));
                console.log('Dados de veículos e motoristas salvos:', { veiculosData, motoristasData });
            } catch (e) {
                console.error('Erro ao salvar dados de veículos/motoristas:', e);
            }
        }

        // SALVAR DADOS NO LOCALSTORAGE
        function saveDataToStorage(csvData) {
            localStorage.setItem('frotaCSVData', csvData);
        }

        // FUNÇÃO PARA VERIFICAR SE É UMA VIAGEM VÁLIDA (USANDO CSV REAL)
        function isViagemValidaReal(item) {
            const destino = item.DESTINO ? item.DESTINO.trim().toUpperCase() : '';
            
            if (!destino) return false;
            
            const destinosInvalidos = [
                destino.includes('COBRANÇA'),
                destino.includes('COBRANCA'),
                destino.startsWith('GARAGEM X'),
                destino.includes(' X GARAGEM'),
                destino === '',
                destino === '-',
                destino === '--',
                destino.includes('RETORNOU CARREGADO'),
                destino.includes('SEM CONDIÇÕES'),
                destino.includes('NÃO SAIU'),
                destino.includes('VEÍCULO NÃO'),
                destino.includes('TRANSBORDO'),
                destino.includes('REBOCOU'),
                destino.includes('TESTE'),
                destino.includes('MANUTENÇÃO')
            ];
            
            return !destinosInvalidos.some(invalido => invalido === true);
        }

        // PROCESSAR DADOS DO CSV - VERSÃO CORRIGIDA PARA O CSV REAL
        function processCSVData(csvString) {
            console.log("Processando dados CSV...");
            
            const lines = csvString.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length === 0) {
                throw new Error('Arquivo CSV vazio');
            }
            
            // Encontrar linha de cabeçalho
            let headerLine = '';
            let dataStartIndex = 0;
            
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i].toUpperCase();
                if (line.includes('DATA') && (line.includes('VEICULO') || line.includes('VEÍCULO'))) {
                    headerLine = lines[i];
                    dataStartIndex = i + 1;
                    break;
                }
            }
            
            // Se não encontrou cabeçalho específico, usa a primeira linha
            if (!headerLine) {
                headerLine = lines[0];
                dataStartIndex = 1;
            }
            
            const headers = headerLine.split(',').map(h => h.trim());
            frotaData = [];
            
            console.log('Cabeçalhos detectados:', headers);
            
            // Processar cada linha de dados
            for (let i = dataStartIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.split(',').length < 5) continue;
                
                const values = parseCSVLine(line);
                const item = {};
                
                // Mapear valores para cabeçalhos
                headers.forEach((header, index) => {
                    item[header] = values[index] ? values[index].trim() : '';
                });
                
                // Garantir que temos os campos necessários
                if (!item.DATA) {
                    console.warn(`Linha ${i + 1} ignorada - sem data`);
                    continue;
                }
                
                // Normalizar nomes de campos
                if (!item.VEICULO && item['VEÍCULO']) item.VEICULO = item['VEÍCULO'];
                if (!item.MOTORISTA && item.Motorista) item.MOTORISTA = item.Motorista;
                if (!item.OP && item.Op) item.OP = item.Op;
                if (!item.DESTINO && item['DESTINO']) item.DESTINO = item['DESTINO'];
                
                // Determinar operação baseada no destino
                if (!item.OP || !operacoesMap[item.OP]) {
                    const destino = item.DESTINO || '';
                    if (destino.toUpperCase().includes('LASA')) item.OP = 'LS';
                    else if (destino.toUpperCase().includes('HORTIFRUTI')) item.OP = 'HT';
                    else if (destino.toUpperCase().includes('TELERIO') || destino.toUpperCase().includes('TELERIO')) item.OP = 'TL';
                    else if (destino.toUpperCase().includes('CASA & VÍDEO') || destino.toUpperCase().includes('CASA E VIDEO')) item.OP = 'CV';
                    else if (destino.toUpperCase().includes('NALIN')) item.OP = 'NL';
                    else item.OP = 'LS'; // Padrão
                }
                
                // Verificar se é viagem válida usando o campo DESTINO
                item.TEM_DESTINO = isViagemValidaReal(item);
                
                // Gerar ID único
                item.id = generateUniqueId(item);
                
                // Determinar status automático
                item.STATUS_AUTO = determineAutoStatus(item);
                item.STATUS_MANUAL = null;
                item.FINALIZADO_MANUALMENTE = false;
                
                // Formatar data para exibição
                item.DATA_DISPLAY = formatDateForDisplay(item.DATA);
                
                // Extrair número da loja
                item.LOJA_NUMERO = item.TEM_DESTINO ? extractLojaNumber(item.DESTINO || '') : '';
                
                // Obter informações da operação
                item.OP_INFO = operacoesMap[item.OP] || { nome: item.OP, cor: '#666' };
                
                frotaData.push(item);
            }
            
            console.log(`Dados processados: ${frotaData.length} registros`);
            saveDataToStorage(csvString);
            
            // Após processar, atualizar tudo
            updateAllAfterDataLoad();
        }

        // PARSE DE LINHA CSV
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(val => val.trim());
        }

        // GERAR ID ÚNICO
        function generateUniqueId(item) {
            const baseId = `${item.DATA}_${item.OP}_${item.VEICULO}_${item.MOTORISTA}_${item['PONTO_ON_MOT.'] || ''}_${item.DESTINO || ''}`
                .replace(/\s+/g, '_')
                .replace(/[^a-zA-Z0-9_]/g, '');
            
            let hash = 0;
            for (let i = 0; i < baseId.length; i++) {
                const char = baseId.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return `${baseId}_${Math.abs(hash)}`;
        }

        // DETERMINAR STATUS AUTOMÁTICO
        function determineAutoStatus(item) {
            if (item['PONTO_OFF_MOTO.'] && item['PONTO_OFF_MOTO.'].trim()) {
                return 'finalizado';
            } else if (item['SAÍDA_VEÍCULO_CD'] && item['SAÍDA_VEÍCULO_CD'].trim()) {
                return 'em-rota';
            } else {
                return 'pendente';
            }
        }

        // FORMATAR DATA PARA EXIBIÇÃO
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            const [day, month, year] = dateStr.split('/');
            const date = new Date(`20${year}`, month - 1, day);
            return date.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
        }

        // EXTRAIR NÚMERO DA LOJA
        function extractLojaNumber(destino) {
            if (!destino) return '';
            const match = destino.match(/(\d+)/);
            return match ? match[0] : '';
        }

        // CARREGAR FINALIZAÇÕES MANUAIS
        function loadManualFinalizations() {
            const saved = localStorage.getItem('frotaManualFinalizations');
            if (saved) {
                try {
                    manualFinalizations = JSON.parse(saved);
                } catch (e) {
                    manualFinalizations = {};
                }
            } else {
                manualFinalizations = {};
            }
        }

        // SALVAR FINALIZAÇÕES MANUAIS
        function saveManualFinalizations() {
            localStorage.setItem('frotaManualFinalizations', JSON.stringify(manualFinalizations));
        }

        // APLICAR FINALIZAÇÕES MANUAIS
        function applyManualFinalizations() {
            frotaData.forEach(item => {
                if (manualFinalizations[item.id]) {
                    item.STATUS_MANUAL = 'finalizado';
                    item.FINALIZADO_MANUALMENTE = true;
                } else {
                    item.STATUS_MANUAL = null;
                    item.FINALIZADO_MANUALMENTE = false;
                }
            });
        }

        // IDENTIFICAR VIAGENS MÚLTIPLAS
        function identifyMultipleTrips() {
            const tripsByVehicleDriverDate = {};
            
            const viagensComDestino = frotaData.filter(item => item.TEM_DESTINO);
            
            viagensComDestino.forEach(item => {
                const key = `${item.VEICULO}_${item.MOTORISTA}_${item.DATA}`;
                if (!tripsByVehicleDriverDate[key]) {
                    tripsByVehicleDriverDate[key] = [];
                }
                tripsByVehicleDriverDate[key].push(item);
            });
            
            frotaData.forEach(item => {
                item.VIAGEM_NUMERO = 1;
                item.TOTAL_VIAGENS = 1;
                item.VIAGEM_MULTIPLA = false;
            });
            
            Object.values(tripsByVehicleDriverDate).forEach(trips => {
                if (trips.length > 1) {
                    trips.forEach((trip, index) => {
                        trip.VIAGEM_NUMERO = index + 1;
                        trip.TOTAL_VIAGENS = trips.length;
                        trip.VIAGEM_MULTIPLA = true;
                    });
                }
            });
        }

        // EXTRAIR TODAS AS DATAS ÚNICAS
        function extractAllDates() {
            const datesSet = new Set();
            
            const viagensComDestino = frotaData.filter(item => item.TEM_DESTINO);
            
            viagensComDestino.forEach(item => {
                if (item.DATA) {
                    datesSet.add(item.DATA);
                }
            });
            
            allDates = Array.from(datesSet).sort((a, b) => {
                const dateA = parseDate(a);
                const dateB = parseDate(b);
                return dateB - dateA;
            });
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const [day, month, year] = dateStr.split('/');
            return new Date(2000 + parseInt(year), parseInt(month) - 1, parseInt(day));
        }

        // ATUALIZAR TUDO APÓS CARREGAR DADOS
        function updateAllAfterDataLoad() {
            applyManualFinalizations();
            identifyMultipleTrips();
            extractAllDates();
            calculateAdvancedStatistics();
            calculateNaoEscaladosAnalysis();
            loadLast3DaysSummary();
            loadControleDiario();
            updateDateFilterOptions();
            loadTableData();
            updateNaoEscalados();
            updateRotaFrequente();
            updateRelacaoVeiculosMotoristas();
            updateTimestamp();
            updateCounters();
        }

        // CALCULAR ESTATÍSTICAS AVANÇADAS
        function calculateAdvancedStatistics() {
            driverStatistics = {};
            routeStatistics = {};
            vehicleStatistics = {};
            
            const viagensComDestino = frotaData.filter(item => item.TEM_DESTINO);
            
            viagensComDestino.forEach(item => {
                const motorista = item.MOTORISTA;
                const veiculo = item.VEICULO;
                const rota = item.DESTINO ? item.DESTINO.substring(0, 50) : 'Não especificada';
                const lojaNumero = item.LOJA_NUMERO;
                
                // Estatísticas por motorista
                if (motorista) {
                    if (!driverStatistics[motorista]) {
                        driverStatistics[motorista] = {
                            nome: motorista,
                            totalViagens: 0,
                            totalDias: new Set(),
                            rotasFrequentes: {},
                            veiculosUtilizados: new Set(),
                            viagensConcluidas: 0,
                            operacoes: {}
                        };
                    }
                    
                    const stats = driverStatistics[motorista];
                    stats.totalViagens++;
                    stats.totalDias.add(item.DATA);
                    stats.veiculosUtilizados.add(veiculo);
                    
                    if (!stats.operacoes[item.OP]) {
                        stats.operacoes[item.OP] = 0;
                    }
                    stats.operacoes[item.OP]++;
                    
                    if (item.STATUS_AUTO === 'finalizado' || item.STATUS_MANUAL === 'finalizado') {
                        stats.viagensConcluidas++;
                    }
                    
                    if (rota && rota !== 'Não especificada') {
                        if (!stats.rotasFrequentes[rota]) {
                            stats.rotasFrequentes[rota] = 0;
                        }
                        stats.rotasFrequentes[rota]++;
                    }
                }
                
                // Estatísticas por rota
                if (rota && rota !== 'Não especificada') {
                    if (!routeStatistics[rota]) {
                        routeStatistics[rota] = {
                            nome: rota,
                            totalViagens: 0,
                            veiculosUtilizados: {},
                            motoristasUtilizados: {},
                            diasOperacao: new Set(),
                            operacoes: {}
                        };
                    }
                    
                    const stats = routeStatistics[rota];
                    stats.totalViagens++;
                    stats.diasOperacao.add(item.DATA);
                    
                    if (!stats.operacoes[item.OP]) {
                        stats.operacoes[item.OP] = 0;
                    }
                    stats.operacoes[item.OP]++;
                    
                    if (veiculo) {
                        if (!stats.veiculosUtilizados[veiculo]) {
                            stats.veiculosUtilizados[veiculo] = 0;
                        }
                        stats.veiculosUtilizados[veiculo]++;
                    }
                    
                    if (motorista) {
                        if (!stats.motoristasUtilizados[motorista]) {
                            stats.motoristasUtilizados[motorista] = 0;
                        }
                        stats.motoristasUtilizados[motorista]++;
                    }
                }
                
                // Estatísticas por veículo
                if (veiculo) {
                    if (!vehicleStatistics[veiculo]) {
                        vehicleStatistics[veiculo] = {
                            placa: veiculo,
                            totalViagens: 0,
                            rotasFrequentes: {},
                            motoristasUtilizados: new Set(),
                            diasOperacao: new Set(),
                            operacoes: {}
                        };
                    }
                    
                    const stats = vehicleStatistics[veiculo];
                    stats.totalViagens++;
                    stats.diasOperacao.add(item.DATA);
                    stats.motoristasUtilizados.add(motorista);
                    
                    if (!stats.operacoes[item.OP]) {
                        stats.operacoes[item.OP] = 0;
                    }
                    stats.operacoes[item.OP]++;
                    
                    if (rota && rota !== 'Não especificada') {
                        if (!stats.rotasFrequentes[rota]) {
                            stats.rotasFrequentes[rota] = 0;
                        }
                        stats.rotasFrequentes[rota]++;
                    }
                }
            });
        }

        // CALCULAR ANÁLISE DE MOTORISTAS NÃO ESCALADOS - VERSÃO CORRIGIDA
        function calculateNaoEscaladosAnalysis() {
            naoEscaladosAnalysis = {
                motoristasHoje: new Set(),
                motoristasTodos: new Set(),
                diasSemTrabalhar: {},
                ultimoTrabalho: {},
                padroesFolga: {},
                motoristasEscaladosHoje: new Set(),
                motoristasComDestinoValidoHoje: new Set()
            };
            
            // Encontrar data atual selecionada
            const dateFilter = document.getElementById('dateFilter').value;
            let dataSelecionada = dateFilter !== 'all' ? dateFilter : getTodayDateString();
            
            console.log('Data selecionada para análise de não escalados:', dataSelecionada);
            
            // Coletar todos os motoristas que já trabalharam (COM OU SEM DESTINO VÁLIDO)
            frotaData.forEach(item => {
                if (item.MOTORISTA && item.MOTORISTA.trim() !== '') {
                    const motorista = item.MOTORISTA.trim();
                    
                    // Adicionar a lista de todos os motoristas
                    naoEscaladosAnalysis.motoristasTodos.add(motorista);
                    
                    // Coletar motoristas que trabalharam na data selecionada (COM OU SEM DESTINO VÁLIDO)
                    if (item.DATA === dataSelecionada) {
                        // Motoristas escalados hoje (todos, independente de ter destino válido)
                        naoEscaladosAnalysis.motoristasEscaladosHoje.add(motorista);
                        
                        // Motoristas com destino válido hoje
                        if (item.TEM_DESTINO) {
                            naoEscaladosAnalysis.motoristasComDestinoValidoHoje.add(motorista);
                        }
                        
                        naoEscaladosAnalysis.motoristasHoje.add(motorista);
                    }
                    
                    // Atualizar último dia de trabalho (considera qualquer viagem, com ou sem destino válido)
                    if (!naoEscaladosAnalysis.ultimoTrabalho[motorista]) {
                        naoEscaladosAnalysis.ultimoTrabalho[motorista] = item.DATA;
                    } else {
                        // Manter a data mais recente
                        const dataAtual = parseDate(naoEscaladosAnalysis.ultimoTrabalho[motorista]);
                        const dataNova = parseDate(item.DATA);
                        if (dataNova > dataAtual) {
                            naoEscaladosAnalysis.ultimoTrabalho[motorista] = item.DATA;
                        }
                    }
                }
            });
            
            // Calcular dias sem trabalhar
            const hoje = parseDate(dataSelecionada);
            
            Object.keys(naoEscaladosAnalysis.ultimoTrabalho).forEach(motorista => {
                const ultimaData = parseDate(naoEscaladosAnalysis.ultimoTrabalho[motorista]);
                if (ultimaData && hoje) {
                    const diffTime = Math.abs(hoje - ultimaData);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    naoEscaladosAnalysis.diasSemTrabalhar[motorista] = diffDays;
                } else {
                    naoEscaladosAnalysis.diasSemTrabalhar[motorista] = 999; // Nunca trabalhou
                }
            });
            
            // Identificar padrões de folga
            Object.keys(naoEscaladosAnalysis.diasSemTrabalhar).forEach(motorista => {
                const dias = naoEscaladosAnalysis.diasSemTrabalhar[motorista];
                
                // Motoristas escalados hoje não estão em folga
                if (naoEscaladosAnalysis.motoristasEscaladosHoje.has(motorista)) {
                    naoEscaladosAnalysis.padroesFolga[motorista] = 'trabalhou_hoje';
                } else if (dias >= 30) {
                    naoEscaladosAnalysis.padroesFolga[motorista] = 'inativo';
                } else if (dias >= 14) {
                    naoEscaladosAnalysis.padroesFolga[motorista] = 'possivel_ferias';
                } else if (dias >= 7) {
                    naoEscaladosAnalysis.padroesFolga[motorista] = 'folga_longa';
                } else if (dias > 0) {
                    naoEscaladosAnalysis.padroesFolga[motorista] = 'folga_curta';
                } else {
                    naoEscaladosAnalysis.padroesFolga[motorista] = 'trabalhou_hoje';
                }
            });
            
            console.log('Análise de não escalados - CORRIGIDA:', {
                dataSelecionada,
                motoristasHoje: Array.from(naoEscaladosAnalysis.motoristasHoje),
                motoristasEscaladosHoje: Array.from(naoEscaladosAnalysis.motoristasEscaladosHoje),
                motoristasComDestinoValidoHoje: Array.from(naoEscaladosAnalysis.motoristasComDestinoValidoHoje),
                padroesFolga: naoEscaladosAnalysis.padroesFolga
            });
        }

        // ATUALIZAR SEÇÃO DE MOTORISTAS NÃO ESCALADOS
        function updateNaoEscalados() {
            calculateNaoEscaladosAnalysis();
            
            // Combina motoristas do sistema com motoristas cadastrados manualmente
            const motoristasDoSistema = Array.from(naoEscaladosAnalysis.motoristasTodos);
            const motoristasCadastrados = motoristasData.lista;
            
            // União de todos os motoristas conhecidos
            const todosMotoristas = [...new Set([...motoristasDoSistema, ...motoristasCadastrados])];
            
            // Encontrar data atual selecionada
            const dateFilter = document.getElementById('dateFilter').value;
            let dataSelecionada = dateFilter !== 'all' ? dateFilter : getTodayDateString();
            
            // Motoristas que trabalharam hoje (incluindo os sem destino válido)
            const motoristasHoje = Array.from(naoEscaladosAnalysis.motoristasEscaladosHoje);
            
            // Motoristas que NÃO foram escalados hoje (não aparecem em nenhuma viagem hoje)
            const motoristasNaoEscaladosHoje = todosMotoristas.filter(m => 
                !motoristasHoje.includes(m)
            );
            
            // Motoristas com destino válido hoje
            const motoristasComDestinoValidoHoje = Array.from(naoEscaladosAnalysis.motoristasComDestinoValidoHoje);
            
            console.log('Estatísticas corrigidas:', {
                todosMotoristas: todosMotoristas.length,
                motoristasHoje: motoristasHoje.length,
                motoristasComDestinoValidoHoje: motoristasComDestinoValidoHoje.length,
                motoristasNaoEscaladosHoje: motoristasNaoEscaladosHoje.length,
                dataSelecionada
            });
            
            // Ordenar motoristas não escalados por dias sem trabalhar (decrescente)
            motoristasNaoEscaladosHoje.sort((a, b) => {
                const diasA = naoEscaladosAnalysis.diasSemTrabalhar[a] || 999;
                const diasB = naoEscaladosAnalysis.diasSemTrabalhar[b] || 999;
                return diasB - diasA;
            });
            
            // Separar em folgas curtas e possíveis férias
            const folgaCurta = motoristasNaoEscaladosHoje.filter(m => {
                const dias = naoEscaladosAnalysis.diasSemTrabalhar[m] || 999;
                const padrao = naoEscaladosAnalysis.padroesFolga[m];
                return (padrao === 'folga_curta' || padrao === 'folga_longa' || 
                       (dias < 7 && dias > 0) || dias === 999) &&
                       !motoristasHoje.includes(m);
            });
            
            const possiveisFerias = motoristasNaoEscaladosHoje.filter(m => {
                const padrao = naoEscaladosAnalysis.padroesFolga[m];
                return (padrao === 'possivel_ferias' || padrao === 'inativo') &&
                       !motoristasHoje.includes(m);
            });
            
            // Atualizar listas
            const folgaList = document.getElementById('folgaList');
            const feriasList = document.getElementById('feriasList');
            
            let folgaHtml = '';
            let feriasHtml = '';
            
            if (folgaCurta.length > 0) {
                folgaCurta.forEach(motorista => {
                    const dias = naoEscaladosAnalysis.diasSemTrabalhar[motorista] || 999;
                    const padrao = naoEscaladosAnalysis.padroesFolga[motorista];
                    const ultimoTrabalho = naoEscaladosAnalysis.ultimoTrabalho[motorista] || 'Nunca trabalhou';
                    
                    let statusClass = 'nao-escalados-status folga';
                    let statusText = dias === 999 ? 'NOVO' : 'FOLGA';
                    
                    if (dias >= 7 && dias < 14) {
                        statusClass = 'nao-escalados-status folga';
                        statusText = 'FOLGA LONGA';
                    }
                    
                    folgaHtml += `
                        <div class="nao-escalados-item">
                            <div class="nao-escalados-nome">
                                ${motorista}
                                <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">
                                    Último trabalho: ${ultimoTrabalho}
                                </div>
                            </div>
                            <div class="nao-escalados-info">
                                <div class="nao-escalados-dias">${dias === 999 ? '?' : dias} dias</div>
                                <div class="${statusClass}">${statusText}</div>
                            </div>
                        </div>
                    `;
                });
            } else {
                folgaHtml = '<div style="text-align: center; padding: 20px; color: #666;">Todos os motoristas escalados hoje</div>';
            }
            
            if (possiveisFerias.length > 0) {
                possiveisFerias.forEach(motorista => {
                    const dias = naoEscaladosAnalysis.diasSemTrabalhar[motorista] || 0;
                    const padrao = naoEscaladosAnalysis.padroesFolga[motorista];
                    const ultimoTrabalho = naoEscaladosAnalysis.ultimoTrabalho[motorista] || 'Nunca trabalhou';
                    
                    let statusClass = 'nao-escalados-status ferias';
                    let statusText = 'POSSÍVEL FÉRIAS';
                    
                    if (dias >= 30) {
                        statusClass = 'nao-escalados-status inativo';
                        statusText = 'INATIVO';
                    }
                    
                    feriasHtml += `
                        <div class="nao-escalados-item">
                            <div class="nao-escalados-nome">
                                ${motorista}
                                <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">
                                    Último: ${ultimoTrabalho}
                                </div>
                            </div>
                            <div class="nao-escalados-info">
                                <div class="nao-escalados-dias">${dias} dias</div>
                                <div class="${statusClass}">${statusText}</div>
                            </div>
                        </div>
                    `;
                });
            } else {
                feriasHtml = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum motorista com padrão de férias</div>';
            }
            
            folgaList.innerHTML = folgaHtml;
            feriasList.innerHTML = feriasHtml;
            
            // Atualizar estatísticas
            const totalMotoristas = todosMotoristas.length;
            const motoristasHojeCount = motoristasHoje.length;
            const naoEscaladosHojeCount = motoristasNaoEscaladosHoje.length;
            const motoristasComDestinoValidoCount = motoristasComDestinoValidoHoje.length;
            
            // Calcular média de dias de folga (apenas para os não escalados)
            let somaDiasFolga = 0;
            let countDiasFolga = 0;
            
            motoristasNaoEscaladosHoje.forEach(m => {
                const dias = naoEscaladosAnalysis.diasSemTrabalhar[m];
                if (dias && dias < 999) { // Ignorar "nunca trabalhou"
                    somaDiasFolga += dias;
                    countDiasFolga++;
                }
            });
            
            const mediaDiasFolga = countDiasFolga > 0 ? Math.round(somaDiasFolga / countDiasFolga) : 0;
            
            // Atualizar os valores na interface
            document.getElementById('totalMotoristasTodos').textContent = totalMotoristas;
            document.getElementById('motoristasHoje').textContent = motoristasHojeCount;
            document.getElementById('naoEscaladosHoje').textContent = naoEscaladosHojeCount;
            document.getElementById('mediaDiasFolga').textContent = mediaDiasFolga;
            
            // Adicionar informação sobre motoristas com/sem destino válido
            console.log(`Motoristas hoje: ${motoristasHojeCount} (${motoristasComDestinoValidoCount} com destino válido)`);
        }

        // CARREGAR RESUMO DOS ÚLTIMOS 3 DIAS (COMEÇANDO DO DIA ATUAL)
        function loadLast3DaysSummary() {
            const daysSummary = {};
            
            const viagensComDestino = frotaData.filter(item => item.TEM_DESTINO);
            
            viagensComDestino.forEach(item => {
                if (!item.DATA) return;
                
                if (!daysSummary[item.DATA]) {
                    daysSummary[item.DATA] = {
                        date: item.DATA,
                        displayDate: item.DATA_DISPLAY,
                        total: 0,
                        operations: {},
                        vehicles: new Set(),
                        drivers: new Set()
                    };
                }
                
                const day = daysSummary[item.DATA];
                day.total++;
                day.vehicles.add(item.VEICULO);
                day.drivers.add(item.MOTORISTA);
                
                if (!day.operations[item.OP]) {
                    day.operations[item.OP] = {
                        count: 0,
                        vehicles: new Set(),
                        nome: item.OP_INFO.nome,
                        cor: item.OP_INFO.cor
                    };
                }
                day.operations[item.OP].count++;
                day.operations[item.OP].vehicles.add(item.VEICULO);
            });
            
            // Ordenar datas de forma decrescente (mais recente primeiro)
            const sortedDates = Object.keys(daysSummary).sort((a, b) => {
                const dateA = parseDate(a);
                const dateB = parseDate(b);
                return dateB - dateA;
            });
            
            // Pegar as 3 datas mais recentes
            const last3Dates = sortedDates.slice(0, 3);
            
            console.log('Últimas 3 datas:', last3Dates);
            
            let html = '';
            last3Dates.forEach(date => {
                const day = daysSummary[date];
                if (!day) return;
                
                const operationsList = Object.entries(day.operations)
                    .sort((a, b) => b[1].count - a[1].count)
                    .map(([op, data]) => {
                        const opClass = op;
                        const nomeCompleto = data.nome || op;
                        
                        return `
                            <div class="op-item ${opClass}">
                                <div class="op-badge ${opClass}" style="background: ${data.cor}">${op}</div>
                                <div class="op-info">
                                    <div class="op-main">
                                        <strong style="color: ${data.cor}">${data.count} viagens</strong>
                                        <span class="op-vehicles">🚛 ${data.vehicles.size} veículos</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #666; font-weight: 600;">
                                        ${nomeCompleto}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                
                html += `
                    <div class="day-card">
                        <div class="day-header">
                            <div class="day-date">${day.displayDate}</div>
                            <div class="day-count">${day.total} viagens</div>
                        </div>
                        <div class="operations-list">
                            ${operationsList}
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; font-size: 0.9rem; color: #666;">
                            <div style="display: flex; gap: 15px;">
                                <span>🚛 ${day.vehicles.size} veículos</span>
                                <span>👷 ${day.drivers.size} motoristas</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (last3Dates.length === 0 || html === '') {
                html = `
                    <div class="day-card">
                        <div class="day-header">
                            <div class="day-date">Sem dados disponíveis</div>
                            <div class="day-count">0 viagens</div>
                        </div>
                        <div style="text-align: center; padding: 30px; color: #666;">
                            Nenhuma viagem com destino válido encontrada
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('last3DaysSummary').innerHTML = html;
        }

        // CARREGAR CONTROLE DIÁRIO DA FROTA COM ANÁLISE DE CONTRATAÇÃO
        function loadControleDiario() {
            const dateFilter = document.getElementById('dateFilter').value;
            let targetDate = dateFilter !== 'all' ? dateFilter : getTodayDateString();
            
            const viagensDoDia = frotaData.filter(item => item.DATA === targetDate && item.TEM_DESTINO);
            
            if (viagensDoDia.length === 0) {
                document.getElementById('controleDiario').innerHTML = `
                    <div class="controle-diario-header">
                        <div class="controle-diario-titulo">
                            <span>📊</span>
                            CONTROLE DIÁRIO DA FROTA
                        </div>
                        <div class="controle-diario-data">${formatDateForDisplay(targetDate)}</div>
                    </div>
                    <div style="text-align: center; padding: 30px; font-size: 1.1rem; opacity: 0.9;">
                        Nenhuma viagem com destino válido encontrada para este dia
                    </div>
                `;
                return;
            }
            
            const totalViagens = viagensDoDia.length;
            const veiculosSet = new Set();
            const motoristasSet = new Set();
            const operacoesCount = {};
            
            viagensDoDia.forEach(item => {
                veiculosSet.add(item.VEICULO);
                motoristasSet.add(item.MOTORISTA);
                
                if (!operacoesCount[item.OP]) {
                    operacoesCount[item.OP] = {
                        count: 0,
                        nome: item.OP_INFO.nome,
                        cor: item.OP_INFO.cor
                    };
                }
                operacoesCount[item.OP].count++;
            });
            
            const totalVeiculos = veiculosSet.size;
            const totalMotoristas = motoristasSet.size;
            
            const finalizadasCount = viagensDoDia.filter(item => 
                item.STATUS_MANUAL === 'finalizado' || item.STATUS_AUTO === 'finalizado'
            ).length;
            
            const emRotaCount = viagensDoDia.filter(item => 
                (item.STATUS_MANUAL || item.STATUS_AUTO) === 'em-rota'
            ).length;
            
            const pendentesCount = viagensDoDia.filter(item => 
                (item.STATUS_MANUAL || item.STATUS_AUTO) === 'pendente'
            ).length;
            
            const finalizadasPercent = totalViagens > 0 ? Math.round((finalizadasCount / totalViagens) * 100) : 0;
            const emRotaPercent = totalViagens > 0 ? Math.round((emRotaCount / totalViagens) * 100) : 0;
            const pendentesPercent = totalViagens > 0 ? Math.round((pendentesCount / totalViagens) * 100) : 0;
            
            // ANÁLISE DE NECESSIDADE DE CONTRATAÇÃO
            const totalMotoristasDisponiveis = motoristasData.total;
            const necessidadeContratacao = totalMotoristas > totalMotoristasDisponiveis ? 
                totalMotoristas - totalMotoristasDisponiveis : 0;
            
            const diferencaMotoristas = totalMotoristasDisponiveis - totalMotoristas;
            const percentualUtilizacao = totalMotoristasDisponiveis > 0 ? 
                Math.round((totalMotoristas / totalMotoristasDisponiveis) * 100) : 100;
            
            let statusContratacao = '';
            let statusClasse = '';
            let statusIcon = '';
            let statusTexto = '';
            
            if (necessidadeContratacao > 0) {
                statusContratacao = 'insufficient';
                statusClasse = 'contratacao-status-badge insufficient';
                statusIcon = '⚠️';
                statusTexto = `NECESSIDADE DE CONTRATAÇÃO: +${necessidadeContratacao} motoristas`;
            } else if (diferencaMotoristas <= 2) {
                statusContratacao = 'marginal';
                statusClasse = 'contratacao-status-badge marginal';
                statusIcon = '📊';
                statusTexto = 'CAPACIDADE NO LIMITE - Monitorar';
            } else {
                statusContratacao = 'sufficient';
                statusClasse = 'contratacao-status-badge sufficient';
                statusIcon = '✅';
                statusTexto = 'CAPACIDADE SUFICIENTE';
            }
            
            const statsHtml = `
                <div class="controle-stat-item">
                    <div class="controle-stat-label">
                        <span>🚛</span>
                        Total de Viagens
                    </div>
                    <div class="controle-stat-value">${totalViagens}</div>
                    <div class="controle-stat-sub">com destino válido</div>
                </div>
                
                <div class="controle-stat-item">
                    <div class="controle-stat-label">
                        <span>🚚</span>
                        Veículos em Operação
                    </div>
                    <div class="controle-stat-value">${totalVeiculos}</div>
                    <div class="controle-stat-sub">diferentes</div>
                </div>
                
                <div class="controle-stat-item">
                    <div class="controle-stat-label">
                        <span>👷</span>
                        Motoristas Ativos
                    </div>
                    <div class="controle-stat-value">${totalMotoristas}</div>
                    <div class="controle-stat-sub">em operação (${percentualUtilizacao}% da capacidade)</div>
                </div>
                
                <div class="controle-stat-item">
                    <div class="controle-stat-label">
                        <span>✅</span>
                        Status do Dia
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 5px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Finalizadas:</span>
                            <span style="font-weight: 700;">${finalizadasCount} (${finalizadasPercent}%)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Em Rota:</span>
                            <span style="font-weight: 700; color: #bbdefb;">${emRotaCount} (${emRotaPercent}%)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Pendentes:</span>
                            <span style="font-weight: 700; color: #fff9c4;">${pendentesCount} (${pendentesPercent}%)</span>
                        </div>
                    </div>
                </div>
            `;
            
            const operationsHtml = Object.entries(operacoesCount)
                .sort((a, b) => b[1].count - a[1].count)
                .map(([op, data]) => {
                    const opClass = op;
                    const cor = data.cor;
                    
                    return `
                        <div class="controle-op-item" style="border-left-color: ${cor}">
                            <div class="controle-op-badge ${opClass}" style="background: ${cor}">
                                ${op}
                            </div>
                            <div class="controle-op-info">
                                <div class="controle-op-sigla" style="color: ${cor}">
                                    ${data.nome}
                                </div>
                                <div class="controle-op-count">
                                    ${data.count} viagens
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            // HTML PARA ANÁLISE DE CONTRATAÇÃO
            const contratacaoHtml = `
                <div class="contratacao-status">
                    <div class="contratacao-header">
                        <div class="contratacao-title">
                            <span class="contratacao-icon">👥</span>
                            Análise de Capacidade de Motoristas
                        </div>
                    </div>
                    
                    <div class="contratacao-content">
                        <div class="contratacao-item">
                            <div class="contratacao-label">Motoristas em Operação</div>
                            <div class="contratacao-value">${totalMotoristas}</div>
                        </div>
                        
                        <div class="contratacao-item">
                            <div class="contratacao-label">Motoristas Disponíveis</div>
                            <div class="contratacao-value">${totalMotoristasDisponiveis}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <div class="${statusClasse}">
                            ${statusIcon} ${statusTexto}
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.9;">
                            ${necessidadeContratacao > 0 ? 
                                `<span style="color: #ffabab;">⚠️ Capacidade insuficiente para a demanda atual. 
                                Recomendado contratar ${necessidadeContratacao} motorista(s).</span>` :
                            diferencaMotoristas <= 2 ? 
                                `<span style="color: #ffcc80;">📊 Capacidade próxima do limite. 
                                Diferença: ${diferencaMotoristas} motorista(s) disponível(eis).</span>` :
                                `<span style="color: #a5d6a7;">✅ Capacidade adequada. 
                                ${diferencaMotoristas} motorista(s) disponível(eis) para demanda extra.</span>`
                            }
                        </div>
                    </div>
                </div>
            `;
            
            const html = `
                <div class="controle-diario-header">
                    <div class="controle-diario-titulo">
                        <span>📊</span>
                        CONTROLE DIÁRIO DA FROTA
                    </div>
                    <div class="controle-diario-data">
                        ${formatDateForDisplay(targetDate)}
                    </div>
                </div>
                
                <div class="controle-diario-stats">
                    ${statsHtml}
                </div>
                
                ${contratacaoHtml}
                
                <div style="margin-top: 20px;">
                    <div class="controle-operations-title">
                        <span>🏢</span>
                        Operações do Dia
                    </div>
                    <div class="controle-operations-grid">
                        ${operationsHtml}
                    </div>
                </div>
                
                <div style="margin-top: 15px; font-size: 0.85rem; opacity: 0.8; text-align: center;">
                    Atualizado em: ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                </div>
            `;
            
            document.getElementById('controleDiario').innerHTML = html;
        }

        // ATUALIZAR RELAÇÃO VEÍCULOS/MOTORISTAS (ORDENADA)
        function updateRelacaoVeiculosMotoristas() {
            console.log('Atualizando relação veículos/motoristas...');
            
            // Atualizar totais
            document.getElementById('totalVeiculos').textContent = veiculosData.total;
            document.getElementById('totalMotoristas').textContent = motoristasData.total;
            document.getElementById('totalVeiculosInfo').textContent = `Total: ${veiculosData.total}`;
            document.getElementById('totalMotoristasInfo').textContent = `Total: ${motoristasData.total}`;
            
            // Calcular estatísticas de uso de veículos
            const veiculoUsage = {};
            const motoristaUsage = {};
            
            frotaData.forEach(item => {
                if (item.VEICULO && item.TEM_DESTINO) {
                    if (!veiculoUsage[item.VEICULO]) {
                        veiculoUsage[item.VEICULO] = 0;
                    }
                    veiculoUsage[item.VEICULO]++;
                }
                
                if (item.MOTORISTA && item.TEM_DESTINO) {
                    if (!motoristaUsage[item.MOTORISTA]) {
                        motoristaUsage[item.MOTORISTA] = 0;
                    }
                    motoristaUsage[item.MOTORISTA]++;
                }
            });
            
            // Ordenar veículos por uso (decrescente)
            const sortedVeiculos = Object.entries(veiculoUsage)
                .sort((a, b) => b[1] - a[1])
                .map(([veiculo, count]) => ({ veiculo, count }));
            
            // Ordenar motoristas por uso (decrescente)
            const sortedMotoristas = Object.entries(motoristaUsage)
                .sort((a, b) => b[1] - a[1])
                .map(([motorista, count]) => ({ motorista, count }));
            
            // Atualizar lista de veículos
            const veiculosList = document.getElementById('veiculosList');
            let veiculosHtml = '';
            
            if (sortedVeiculos.length > 0) {
                sortedVeiculos.forEach((item, index) => {
                    veiculosHtml += `
                        <div class="relacao-item">
                            <div class="relacao-nome">${item.veiculo}</div>
                            <div class="relacao-count">${item.count}</div>
                        </div>
                    `;
                });
            } else {
                veiculosHtml = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum veículo encontrado</div>';
            }
            
            veiculosList.innerHTML = veiculosHtml;
            
            // Atualizar lista de motoristas
            const motoristasList = document.getElementById('motoristasList');
            let motoristasHtml = '';
            
            // Combina motoristas do sistema com motoristas cadastrados manualmente
            const motoristasDoSistema = new Set(Object.keys(motoristaUsage));
            const motoristasCadastrados = new Set(motoristasData.lista);
            
            // União de todos os motoristas
            const todosMotoristas = [...new Set([...motoristasDoSistema, ...motoristasCadastrados])];
            
            if (todosMotoristas.length > 0) {
                todosMotoristas.forEach(motorista => {
                    const count = motoristaUsage[motorista] || 0;
                    motoristasHtml += `
                        <div class="relacao-item">
                            <div class="relacao-nome">${motorista}</div>
                            <div class="relacao-count">${count}</div>
                        </div>
                    `;
                });
                
                // Atualizar total se não estiver definido
                if (motoristasData.total === 0) {
                    motoristasData.total = todosMotoristas.length;
                    document.getElementById('totalMotoristas').textContent = motoristasData.total;
                    document.getElementById('totalMotoristasInfo').textContent = `Total: ${motoristasData.total}`;
                    saveVeiculosMotoristasData();
                }
            } else {
                motoristasHtml = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum motorista encontrado</div>';
            }
            
            motoristasList.innerHTML = motoristasHtml;
            
            console.log('Relação atualizada:', {
                veiculos: veiculosData.total,
                motoristas: motoristasData.total,
                listaMotoristas: motoristasData.lista
            });
            
            // Atualizar também o Controle Diário para refletir os novos totais
            loadControleDiario();
        }

        // ATUALIZAR OPÇÕES DO FILTRO DE DATA
        function updateDateFilterOptions() {
            const select = document.getElementById('dateFilter');
            select.innerHTML = '<option value="all">Todas as Datas</option>';
            
            allDates.forEach(date => {
                const [day, month, year] = date.split('/');
                const dateObj = new Date(`20${year}`, month - 1, day);
                const displayDate = dateObj.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                
                const count = frotaData.filter(item => item.DATA === date && item.TEM_DESTINO).length;
                
                const option = document.createElement('option');
                option.value = date;
                option.textContent = `${displayDate} (${count} viagens)`;
                select.appendChild(option);
            });
            
            // Selecionar a data de hoje se disponível
            const hoje = getTodayDateString();
            if (allDates.includes(hoje)) {
                select.value = hoje;
            } else if (allDates.length > 0) {
                select.value = allDates[0];
            }
        }

        // CARREGAR DADOS DA TABELA - MODIFICADA PARA NOVO BOTÃO
        function loadTableData() {
            const filteredData = getFilteredData();
            const tableBody = document.getElementById('tableBody');
            
            let html = '';
            
            filteredData.forEach((item, index) => {
                const statusFinal = item.STATUS_MANUAL || item.STATUS_AUTO;
                const isFinalizadoManualmente = item.FINALIZADO_MANUALMENTE;
                const temDestino = item.TEM_DESTINO;
                
                let rowClass = '';
                let statusClass = '';
                
                if (!temDestino) {
                    rowClass = 'sem-destino';
                    statusClass = 'status-sem-destino';
                } else {
                    rowClass = statusFinal.replace(' ', '-');
                    statusClass = `status-${statusFinal.replace(' ', '-')}`;
                }
                
                if (isFinalizadoManualmente) {
                    rowClass += ' veiculo-finalizado';
                }
                
                const destino = formatDestination(item.DESTINO || '');
                const isMultipleTrip = temDestino && item.VIAGEM_MULTIPLA;
                const opInfo = item.OP_INFO || operacoesMap[item.OP] || { nome: item.OP, cor: '#666' };
                
                let statusText = statusFinal.toUpperCase();
                if (!temDestino) {
                    statusText = 'SEM DESTINO VÁLIDO';
                }
                
                // Determinar o tipo de botão
                let controleBtnHtml = '';
                if (!temDestino) {
                    controleBtnHtml = `
                        <button class="controle-btn sem-destino" disabled>
                            Sem Destino
                        </button>
                    `;
                } else if (isFinalizadoManualmente) {
                    controleBtnHtml = `
                        <button class="controle-btn fim-viagem" disabled>
                            FIM DE VIAGEM
                        </button>
                    `;
                } else {
                    controleBtnHtml = `
                        <button class="controle-btn inicial" onclick="toggleControleBtn('${item.id}')" title="Clique para finalizar viagem">
                            ○
                        </button>
                    `;
                }
                
                html += `
                    <tr class="${rowClass}" data-id="${item.id}">
                        <td style="font-weight: 700; color: ${temDestino ? '#424242' : '#9e9e9e'};">${index + 1}</td>
                        <td style="font-weight: 600; color: ${temDestino ? '#1a237e' : '#9e9e9e'};">${item.DATA}</td>
                        <td>
                            <div class="op-cell ${item.OP}" style="background: ${opInfo.cor}; opacity: ${temDestino ? '1' : '0.7'}">
                                ${item.OP}
                            </div>
                        </td>
                        <td style="font-weight: 600; color: ${temDestino ? '#1a237e' : '#9e9e9e'};">${item.VEICULO}</td>
                        <td style="font-weight: 600; color: ${temDestino ? '#1a237e' : '#9e9e9e'};">${item.MOTORISTA}</td>
                        <td>${item['PONTO_ON_MOT.'] || '-'}</td>
                        <td>${item['SAÍDA_VEÍCULO_CD'] || '-'}</td>
                        <td style="color: ${temDestino ? '#1a237e' : '#9e9e9e'};">${destino}</td>
                        <td>${item['PONTO_OFF_MOTO.'] || '-'}</td>
                        <td>
                            <span class="status-indicator ${statusClass}">
                                ${isFinalizadoManualmente ? '✓ ' : ''}
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            ${controleBtnHtml}
                        </td>
                        <td>
                            ${temDestino ? (
                                isMultipleTrip ? 
                                    `<span style="color: #ff9800; font-weight: 700;">
                                        ${item.VIAGEM_NUMERO}ª de ${item.TOTAL_VIAGENS}
                                        <span class="trip-badge">MÚLTIPLA</span>
                                    </span>` : 
                                    '1ª viagem'
                            ) : 'N/A'}
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html || `
                <tr>
                    <td colspan="12" style="text-align: center; padding: 50px; color: #666; font-size: 1.1rem;">
                        Nenhuma viagem encontrada com os filtros atuais
                    </td>
                </tr>
            `;
            
            const viagensComDestinoCount = filteredData.filter(item => item.TEM_DESTINO).length;
            const totalViagensCount = filteredData.length;
            const destinoFilter = document.getElementById('destinoFilter').value;
            
            if (destinoFilter === 'com-destino') {
                document.getElementById('tripCount').textContent = `(${viagensComDestinoCount} viagens com destino válido)`;
            } else if (destinoFilter === 'sem-destino') {
                document.getElementById('tripCount').textContent = `(${totalViagensCount - viagensComDestinoCount} viagens sem destino válido)`;
            } else {
                document.getElementById('tripCount').textContent = `(${totalViagensCount} viagens total)`;
            }
        }

        // TOGGLE CONTROLE BUTTON - NOVA FUNÇÃO PARA O BOTÃO REDONDO
        function toggleControleBtn(id) {
            const item = frotaData.find(item => item.id === id);
            if (!item) return;
            
            if (!item.TEM_DESTINO) {
                showNotification('Não é possível finalizar uma viagem sem destino válido', 'error');
                return;
            }
            
            if (item.FINALIZADO_MANUALMENTE) {
                showNotification('Esta viagem já foi finalizada!', 'info');
                return;
            }
            
            // Alternar finalização manual
            if (manualFinalizations[id]) {
                delete manualFinalizations[id];
                item.STATUS_MANUAL = null;
                item.FINALIZADO_MANUALMENTE = false;
            } else {
                manualFinalizations[id] = {
                    timestamp: new Date().toISOString(),
                    autoStatus: item.STATUS_AUTO
                };
                item.STATUS_MANUAL = 'finalizado';
                item.FINALIZADO_MANUALMENTE = true;
            }
            
            saveManualFinalizations();
            
            // Atualizar a linha específica em vez de recarregar toda a tabela
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (row) {
                const controleTd = row.cells[10]; // Coluna Controle é a 11ª (índice 10)
                if (item.FINALIZADO_MANUALMENTE) {
                    controleTd.innerHTML = `
                        <button class="controle-btn fim-viagem" disabled>
                            FIM DE VIAGEM
                        </button>
                    `;
                    
                    // Atualizar status também
                    const statusTd = row.cells[9];
                    statusTd.innerHTML = `
                        <span class="status-indicator status-finalizado">
                            ✓ FINALIZADO
                        </span>
                    `;
                    
                    // Adicionar classe de finalizado à linha
                    row.classList.add('veiculo-finalizado');
                    row.classList.remove('em-rota', 'pendente');
                    row.classList.add('finalizado');
                }
            }
            
            // Atualizar outras seções
            loadControleDiario();
            calculateAdvancedStatistics();
            calculateNaoEscaladosAnalysis();
            updateNaoEscalados();
            updateRotaFrequente();
            
            showNotification(
                item.FINALIZADO_MANUALMENTE ? 
                `✅ Viagem finalizada com sucesso!` :
                `📝 Finalização removida`,
                item.FINALIZADO_MANUALMENTE ? 'success' : 'info'
            );
        }

        // FORMATAR DESTINO
        function formatDestination(destino) {
            if (!destino || destino.trim() === '') return '<span style="color: #9e9e9e; font-style: italic;">Sem destino</span>';
            
            const destinoUpper = destino.toUpperCase();
            if (destinoUpper.includes('COBRANÇA') || 
                destinoUpper.includes('COBRANCA') ||
                destinoUpper.startsWith('GARAGEM X') ||
                destinoUpper.includes(' X GARAGEM') ||
                destinoUpper.includes('RETORNOU CARREGADO') ||
                destinoUpper.includes('SEM CONDIÇÕES') ||
                destinoUpper.includes('NÃO SAIU') ||
                destinoUpper.includes('VEÍCULO NÃO') ||
                destinoUpper.includes('TRANSBORDO')) {
                return `<span style="color: #9e9e9e; font-style: italic;">${destino.substring(0, 50)}${destino.length > 50 ? '...' : ''} (inválido)</span>`;
            }
            
            const lojaMatch = destino.match(/(\d+)/);
            if (lojaMatch) {
                const lojaNum = lojaMatch[0];
                const nomePart = destino.split('-').slice(1).join('-').trim() || destino.split(' ').slice(1).join(' ').trim();
                const nome = nomePart.substring(0, 25);
                return `<span title="${destino}">${lojaNum} - ${nome}${nomePart.length > 25 ? '...' : ''}</span>`;
            }
            
            return destino.substring(0, 30) + (destino.length > 30 ? '...' : '');
        }

        // OBTER DADOS FILTRADOS
        function getFilteredData() {
            let filtered = [...frotaData];
            
            const dateFilter = document.getElementById('dateFilter').value;
            if (dateFilter !== 'all') {
                filtered = filtered.filter(item => item.DATA === dateFilter);
            }
            
            const opFilter = document.getElementById('opFilter').value;
            if (opFilter !== 'all') {
                filtered = filtered.filter(item => item.OP === opFilter);
            }
            
            const statusFilter = document.getElementById('statusFilter').value;
            if (statusFilter !== 'all') {
                filtered = filtered.filter(item => {
                    if (statusFilter === 'com-destino') {
                        return item.TEM_DESTINO;
                    } else if (statusFilter === 'sem-destino') {
                        return !item.TEM_DESTINO;
                    } else {
                        const status = item.STATUS_MANUAL || item.STATUS_AUTO;
                        return status === statusFilter;
                    }
                });
            }
            
            const destinoFilter = document.getElementById('destinoFilter').value;
            if (destinoFilter === 'com-destino') {
                filtered = filtered.filter(item => item.TEM_DESTINO);
            } else if (destinoFilter === 'sem-destino') {
                filtered = filtered.filter(item => !item.TEM_DESTINO);
            }
            
            return filtered;
        }

        // FILTRAR TABELA
        function filterTable() {
            loadTableData();
            loadControleDiario();
            calculateAdvancedStatistics();
            calculateNaoEscaladosAnalysis();
            updateNaoEscalados();
            updateRotaFrequente();
            updateRelacaoVeiculosMotoristas();
        }

        // CARREGAR DATA ESPECÍFICA
        function loadDate(type) {
            let targetDate = '';
            let displayText = '';
            
            switch(type) {
                case 'today':
                    const today = new Date();
                    const todayFormatted = getTodayDateString();
                    targetDate = todayFormatted;
                    displayText = today.toLocaleDateString('pt-BR', { 
                        weekday: 'long', 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric' 
                    });
                    break;
                case 'yesterday':
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayFormatted = getYesterdayDateString();
                    targetDate = yesterdayFormatted;
                    displayText = yesterday.toLocaleDateString('pt-BR', { 
                        weekday: 'long', 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric' 
                    });
                    break;
                case 'all':
                    targetDate = 'all';
                    displayText = 'Todas as Datas';
                    break;
            }
            
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('currentDateDisplay').textContent = displayText;
            document.getElementById('dateFilter').value = targetDate;
            
            filterTable();
        }

        // TOGGLE FINALIZAÇÃO MANUAL - MANTIDA PARA COMPATIBILIDADE
        function toggleFinalization(id) {
            // Esta função é mantida apenas para compatibilidade
            // A nova função toggleControleBtn é a que realmente funciona
            toggleControleBtn(id);
        }

        // ATUALIZAR ROTAS FREQUENTES
        function updateRotaFrequente() {
            const routes = Object.values(routeStatistics)
                .sort((a, b) => b.totalViagens - a[1].totalViagens)
                .slice(0, 10);
            
            let html = '';
            
            routes.forEach(route => {
                const nomeExibicao = route.nome.length > 40 ? route.nome.substring(0, 40) + '...' : route.nome;
                const diasOperacao = route.diasOperacao.size;
                const veiculoMaisUtilizado = Object.keys(route.veiculosUtilizados).reduce((a, b) => 
                    route.veiculosUtilizados[a] > route.veiculosUtilizados[b] ? a : b, 'Não definido'
                );
                const motoristaMaisFrequente = Object.keys(route.motoristasUtilizados).reduce((a, b) => 
                    route.motoristasUtilizados[a] > route.motoristasUtilizados[b] ? a : b, 'Não definido'
                );
                
                const opMaisFrequente = Object.keys(route.operacoes).reduce((a, b) => 
                    route.operacoes[a] > route.operacoes[b] ? a : b, 'Não definida'
                );
                const opInfo = operacoesMap[opMaisFrequente] || { nome: opMaisFrequente, cor: '#666' };
                
                html += `
                    <div class="rota-card">
                        <div class="rota-header">
                            <div class="rota-titulo">${nomeExibicao}</div>
                            <div style="background: ${opInfo.cor}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: 700;">
                                ${route.totalViagens} viagens
                            </div>
                        </div>
                        
                        <div class="rota-metricas">
                            <div>
                                <span style="color: #666; font-size: 0.85rem;">Dias de operação:</span>
                                <div style="font-weight: 700; color: #1a237e;">${diasOperacao}</div>
                            </div>
                            <div>
                                <span style="color: #666; font-size: 0.85rem;">Operação principal:</span>
                                <div style="display: flex; align-items: center; gap: 5px; margin-top: 2px;">
                                    <div class="op-cell ${opMaisFrequente}" style="background: ${opInfo.cor}; font-size: 0.8rem; padding: 2px 8px;">
                                        ${opMaisFrequente}
                                    </div>
                                    <span style="font-size: 0.85rem; color: #666;">${opInfo.nome}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="rota-veiculos">
                            <div style="display: flex; gap: 20px; font-size: 0.85rem;">
                                <div>
                                    <span style="color: #666;">Veículo mais usado:</span>
                                    <div class="veiculo-frequente">${veiculoMaisUtilizado}</div>
                                </div>
                                <div>
                                    <span style="color: #666;">Motorista frequente:</span>
                                    <div style="color: #1a237e; font-weight: 600;">${motoristaMaisFrequente}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (routes.length === 0) {
                html = '<div style="text-align: center; padding: 30px; color: #666;">Nenhuma rota com destino válido encontrada</div>';
            }
            
            document.getElementById('rotaFrequenteContent').innerHTML = html;
        }

        // ============================================
        // FUNÇÕES DE CONTROLE E MODAIS
        // ============================================

        // ABRIR MODAL DE ATUALIZAÇÃO DE VEÍCULOS
        function openUpdateVeiculosModal() {
            document.getElementById('veiculosInput').value = veiculosData.total;
            document.getElementById('veiculosLS').value = veiculosData.distribuicao.LS;
            document.getElementById('veiculosHT').value = veiculosData.distribuicao.HT;
            document.getElementById('veiculosTL').value = veiculosData.distribuicao.TL;
            document.getElementById('veiculosCV').value = veiculosData.distribuicao.CV;
            document.getElementById('veiculosNL').value = veiculosData.distribuicao.NL;
            document.getElementById('updateVeiculosModal').style.display = 'flex';
        }

        // FECHAR MODAL DE ATUALIZAÇÃO DE VEÍCULOS
        function closeUpdateVeiculosModal() {
            document.getElementById('updateVeiculosModal').style.display = 'none';
        }

        // ATUALIZAR DADOS DE VEÍCULOS
        function updateVeiculos() {
            const total = parseInt(document.getElementById('veiculosInput').value) || 0;
            const ls = parseInt(document.getElementById('veiculosLS').value) || 0;
            const ht = parseInt(document.getElementById('veiculosHT').value) || 0;
            const tl = parseInt(document.getElementById('veiculosTL').value) || 0;
            const cv = parseInt(document.getElementById('veiculosCV').value) || 0;
            const nl = parseInt(document.getElementById('veiculosNL').value) || 0;
            
            // Validar se a soma das distribuições não excede o total
            const somaDistribuicao = ls + ht + tl + cv + nl;
            if (somaDistribuicao > total) {
                showNotification('A soma das distribuições por operação não pode ser maior que o total de veículos!', 'error');
                return;
            }
            
            veiculosData = {
                total: total,
                distribuicao: {
                    LS: ls,
                    HT: ht,
                    TL: tl,
                    CV: cv,
                    NL: nl
                }
            };
            
            saveVeiculosMotoristasData();
            updateRelacaoVeiculosMotoristas();
            closeUpdateVeiculosModal();
            
            showNotification(`Total de veículos atualizado para ${total}`, 'success');
        }

        // ABRIR MODAL DE ATUALIZAÇÃO DE MOTORISTAS
        function openUpdateMotoristasModal() {
            document.getElementById('motoristasInput').value = motoristasData.total;
            document.getElementById('motoristasListInput').value = motoristasData.lista.join('\n');
            document.getElementById('updateMotoristasModal').style.display = 'flex';
        }

        // FECHAR MODAL DE ATUALIZAÇÃO DE MOTORISTAS
        function closeUpdateMotoristasModal() {
            document.getElementById('updateMotoristasModal').style.display = 'none';
        }

        // ATUALIZAR DADOS DE MOTORISTAS
        function updateMotoristas() {
            const total = parseInt(document.getElementById('motoristasInput').value) || 0;
            const listaTexto = document.getElementById('motoristasListInput').value;
            
            // Processar lista de motoristas
            const novaLista = listaTexto.split('\n')
                .map(nome => nome.trim())
                .filter(nome => nome.length > 0);
            
            // Combinar com lista existente, removendo duplicatas
            const listaCombinada = [...new Set([...motoristasData.lista, ...novaLista])];
            
            // Se o total for maior que 0, ajustar a lista
            let listaFinal = listaCombinada;
            if (total > 0 && listaCombinada.length < total) {
                // Adicionar motoristas genéricos se necessário
                for (let i = listaCombinada.length; i < total; i++) {
                    listaFinal.push(`Motorista ${i + 1}`);
                }
            } else if (total > 0 && listaCombinada.length > total) {
                // Limitar ao total informado
                listaFinal = listaCombinada.slice(0, total);
            }
            
            motoristasData = {
                total: total,
                lista: listaFinal
            };
            
            saveVeiculosMotoristasData();
            updateRelacaoVeiculosMotoristas();
            closeUpdateMotoristasModal();
            
            showNotification(`Total de motoristas atualizado para ${total}`, 'success');
        }

        // SOLICITAR SENHA PARA IMPORTAR DADOS
        function requestPassword() {
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordModal').style.display = 'flex';
        }

        // FECHAR MODAL DE SENHA
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        // VERIFICAR SENHA
        function verifyPassword() {
            const password = document.getElementById('passwordInput').value;
            
            if (password === SUPERVISOR_PASSWORD) {
                closePasswordModal();
                document.getElementById('fileInput').click();
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        // HANDLE FILE UPLOAD
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Por favor, selecione um arquivo CSV!');
                return;
            }
            
            showLoading();
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    
                    if (!csvData || csvData.trim().length === 0) {
                        throw new Error('Arquivo CSV vazio');
                    }
                    
                    // Processar os dados
                    processCSVData(csvData);
                    
                    showNotification(
                        `Dados atualizados com sucesso! ${frotaData.length} registros carregados (${frotaData.filter(item => item.TEM_DESTINO).length} com destino válido).`,
                        'success'
                    );
                    
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    showNotification(`Erro ao processar arquivo: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            };
            
            reader.onerror = function() {
                alert('Erro ao ler o arquivo');
                hideLoading();
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // CONFIRMAR LIMPEZA DE DADOS
        function confirmClearData() {
            if (confirm('⚠️ ATENÇÃO: Esta ação irá REMOVER TODOS os dados do sistema!\n\nIsso inclui:\n• Todos os registros de viagens\n• Finalizações manuais\n• Estatísticas\n• Dados de veículos e motoristas\n• Análise de motoristas não escalados\n\nVocê poderá importar um novo arquivo CSV após a limpeza.\n\nTem certeza que deseja continuar?')) {
                clearAllData();
            }
        }

        // LIMPAR TODOS OS DADOS
        function clearAllData() {
            showLoading();
            
            try {
                // Limpar arrays
                frotaData = [];
                manualFinalizations = {};
                allDates = [];
                driverStatistics = {};
                routeStatistics = {};
                vehicleStatistics = {};
                naoEscaladosAnalysis = {
                    motoristasHoje: new Set(),
                    motoristasTodos: new Set(),
                    diasSemTrabalhar: {},
                    ultimoTrabalho: {},
                    padroesFolga: {},
                    motoristasEscaladosHoje: new Set(),
                    motoristasComDestinoValidoHoje: new Set()
                };
                
                // Limpar dados de veículos e motoristas
                veiculosData = {
                    total: 0,
                    distribuicao: {
                        LS: 0,
                        HT: 0,
                        TL: 0,
                        CV: 0,
                        NL: 0
                    }
                };
                
                motoristasData = {
                    total: 0,
                    lista: []
                };
                
                // Limpar localStorage
                localStorage.removeItem('frotaCSVData');
                localStorage.removeItem('frotaManualFinalizations');
                localStorage.removeItem('frotaVeiculosData');
                localStorage.removeItem('frotaMotoristasData');
                
                // Resetar para dados iniciais
                processCSVData(initialFrotaData);
                
                showNotification('✅ Todos os dados foram removidos com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao limpar dados:', error);
                showNotification('Erro ao limpar dados: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ABRIR MODAL DE EXPORTAÇÃO
        function openExportModal() {
            if (Object.keys(routeStatistics).length === 0) {
                showNotification('Nenhuma rota encontrada para exportar.', 'error');
                return;
            }
            
            const excelData = generateExcelExportData();
            const jsonData = generateJsonExportData();
            
            document.getElementById('exportExcelData').value = excelData;
            document.getElementById('exportJsonData').value = jsonData;
            
            document.getElementById('exportModal').style.display = 'flex';
        }

        // FECHAR MODAL DE EXPORTAÇÃO
        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        // GERAR DADOS PARA EXPORTAÇÃO EM FORMATO CSV
        function generateExcelExportData() {
            const routes = Object.values(routeStatistics)
                .sort((a, b) => b.totalViagens - a[1].totalViagens);
            
            let csvData = "Rota,Total Viagens,Dias Operação,Veículo Mais Usado,Veículo Uso Count,Motorista Mais Frequente,Operação Principal\n";
            
            routes.forEach(route => {
                const rota = route.nome.replace(/,/g, ';');
                const totalViagens = route.totalViagens;
                const diasOperacao = route.diasOperacao.size;
                const veiculoMaisUtilizado = Object.keys(route.veiculosUtilizados).reduce((a, b) => 
                    route.veiculosUtilizados[a] > route.veiculosUtilizados[b] ? a : b, 'N/A'
                );
                const veiculoUsoCount = route.veiculosUtilizados[veiculoMaisUtilizado] || 0;
                const motoristaMaisFrequente = Object.keys(route.motoristasUtilizados).reduce((a, b) => 
                    route.motoristasUtilizados[a] > route.motoristasUtilizados[b] ? a : b, 'N/A'
                );
                const operacaoPrincipal = Object.keys(route.operacoes).reduce((a, b) => 
                    route.operacoes[a] > route.operacoes[b] ? a : b, 'N/A'
                );
                
                csvData += `"${rota}",${totalViagens},${diasOperacao},"${veiculoMaisUtilizado}",${veiculoUsoCount},"${motoristaMaisFrequente}","${operacaoPrincipal}"\n`;
            });
            
            const exportDate = new Date().toLocaleString('pt-BR');
            const totalRotas = routes.length;
            const totalViagensTotal = routes.reduce((sum, route) => sum + route.totalViagens, 0);
            
            csvData += `\n\nMETADADOS DA EXPORTAÇÃO\n`;
            csvData += `Data da exportação:,${exportDate}\n`;
            csvData += `Total de rotas únicas:,${totalRotas}\n`;
            csvData += `Total de viagens:,${totalViagensTotal}\n`;
            csvData += `Filtro aplicado:,Apenas viagens com destino válido\n`;
            csvData += `Sistema:,Controle de Frota - Dashboard Completo\n`;
            
            return csvData;
        }

        // GERAR DADOS JSON PARA EXPORTAÇÃO
        function generateJsonExportData() {
            const routes = Object.values(routeStatistics)
                .sort((a, b) => b.totalViagens - a[1].totalViagens)
                .map(route => ({
                    rota: route.nome,
                    totalViagens: route.totalViagens,
                    diasOperacao: Array.from(route.diasOperacao),
                    veiculoMaisUtilizado: Object.keys(route.veiculosUtilizados).reduce((a, b) => 
                        route.veiculosUtilizados[a] > route.veiculosUtilizados[b] ? a : b, 'N/A'
                    ),
                    veiculoUsoCount: route.veiculosUtilizados[Object.keys(route.veiculosUtilizados).reduce((a, b) => 
                        route.veiculosUtilizados[a] > route.veiculosUtilizados[b] ? a : b, 'N/A'
                    )] || 0,
                    motoristaMaisFrequente: Object.keys(route.motoristasUtilizados).reduce((a, b) => 
                        route.motoristasUtilizados[a] > route.motoristasUtilizados[b] ? a : b, 'N/A'
                    ),
                    operacaoPrincipal: Object.keys(route.operacoes).reduce((a, b) => 
                        route.operacoes[a] > route.operacoes[b] ? a : b, 'N/A'
                    ),
                    operacoesDetalhadas: route.operacoes,
                    veiculosUtilizados: route.veiculosUtilizados,
                    motoristasUtilizados: route.motoristasUtilizados
                }));
            
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    exportDateDisplay: new Date().toLocaleString('pt-BR'),
                    totalRotas: routes.length,
                    totalViagens: routes.reduce((sum, route) => sum + route.totalViagens, 0),
                    filtroAplicado: 'Apenas viagens com destino válido',
                    sistema: 'Controle de Frota - Dashboard Completo'
                },
                rotas: routes
            };
            
            return JSON.stringify(exportData, null, 2);
        }

        // COPIAR DADOS PARA EXCEL
        function copyExcelData() {
            const textarea = document.getElementById('exportExcelData');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showNotification('Dados copiados para a área de transferência! Cole na célula A1 do Excel ou Google Sheets.', 'success');
            } catch (err) {
                showNotification('Erro ao copiar dados. Use Ctrl+C manualmente.', 'error');
            }
        }

        // COPIAR DADOS JSON
        function copyJsonData() {
            const textarea = document.getElementById('exportJsonData');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showNotification('Dados JSON copiados para a área de transferência!', 'success');
            } catch (err) {
                showNotification('Erro ao copiar dados. Use Ctrl+C manualmente.', 'error');
            }
        }

        // COPIAR ROTAS PARA PLANILHA
        function copyRoutesToClipboard() {
            const routes = Object.values(routeStatistics)
                .sort((a, b) => b.totalViagens - a[1].totalViagens)
                .slice(0, 20);
            
            if (routes.length === 0) {
                showNotification('Nenhuma rota encontrada para copiar.', 'error');
                return;
            }
            
            let clipboardData = "ROTA\tTOTAL VIAGENS\tDIAS OPERAÇÃO\tVEÍCULO MAIS USADO\tMOTORISTA FREQUENTE\tOPERAÇÃO PRINCIPAL\n";
            
            routes.forEach(route => {
                const veiculoMaisUtilizado = Object.keys(route.veiculosUtilizados).reduce((a, b) => 
                    route.veiculosUtilizados[a] > route.veiculosUtilizados[b] ? a : b, 'N/A'
                );
                const motoristaMaisFrequente = Object.keys(route.motoristasUtilizados).reduce((a, b) => 
                    route.motoristasUtilizados[a] > route.motoristasUtilizados[b] ? a : b, 'N/A'
                );
                const operacaoPrincipal = Object.keys(route.operacoes).reduce((a, b) => 
                    route.operacoes[a] > route.operacoes[b] ? a : b, 'N/A'
                );
                
                clipboardData += `${route.nome}\t${route.totalViagens}\t${route.diasOperacao.size}\t${veiculoMaisUtilizado}\t${motoristaMaisFrequente}\t${operacaoPrincipal}\n`;
            });
            
            clipboardData += `\nExportado em: ${new Date().toLocaleString('pt-BR')}\n`;
            clipboardData += `Total de rotas: ${routes.length}\n`;
            clipboardData += `Apenas viagens com destino válido`;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(clipboardData)
                    .then(() => {
                        showNotification('Dados copiados para a área de transferência! Cole em qualquer planilha.', 'success');
                    })
                    .catch(err => {
                        fallbackCopyTextToClipboard(clipboardData);
                    });
            } else {
                fallbackCopyTextToClipboard(clipboardData);
            }
        }

        // FALLBACK PARA COPIAR TEXTO
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('Dados copiados para a área de transferência! Cole em qualquer planilha.', 'success');
            } catch (err) {
                showNotification('Erro ao copiar dados. Tente manualmente com Ctrl+C.', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // MOSTRAR NOTIFICAÇÃO
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                font-weight: 600;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ATUALIZAR CONTADORES
        function updateCounters() {
            const totalRegistros = frotaData.length;
            const viagensComDestino = frotaData.filter(item => item.TEM_DESTINO).length;
            
            document.getElementById('totalRecords').textContent = totalRegistros;
            document.getElementById('totalViagensComDestino').textContent = viagensComDestino;
        }

        // ATUALIZAR TIMESTAMP
        function updateTimestamp() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            const dateStr = now.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            
            document.getElementById('lastUpdate').textContent = `${dateStr} às ${timeStr}`;
        }

        // MOSTRAR LOADING
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // ESCONDER LOADING
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Adicionar eventos para upload box (garantir funcionamento)
        document.addEventListener('DOMContentLoaded', function() {
            // Garantir que o upload box funcione
            const uploadBox = document.querySelector('.upload-box');
            
            if (uploadBox) {
                uploadBox.addEventListener('click', function() {
                    requestPassword();
                });
            }
            
            console.log('Dashboard totalmente carregado e funcional!');
        });

    </script>
</body>
</html>
